# GitHub Actions

**CI/CD integration for automated testing and deployment**

---

## Overview

GitHub Actions provides continuous integration and deployment (CI/CD) for TTA.dev. Every commit triggers automated testing, linting, type checking, and validation to ensure code quality and prevent regressions.

**Documentation:** [GitHub Actions Docs](https://docs.github.com/en/actions)
**TTA.dev Workflows:** `.github/workflows/`

---

## Key Workflows

### 1. Test Workflow

**File:** `.github/workflows/test.yml`

**Triggers:**
- Push to `main` or `develop` branches
- Pull request to `main` or `develop`
- Manual workflow dispatch

**Jobs:**
- **Unit tests**: Fast tests without external dependencies
- **Integration tests**: Tests with Docker services (optional)
- **Coverage reporting**: Code coverage upload to Codecov

**Example:**

```yaml
name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Sync dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest -v --cov=packages --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
```

### 2. Quality Check Workflow

**File:** `.github/workflows/quality.yml`

**Triggers:**
- Push to any branch
- Pull request
- Manual dispatch

**Jobs:**
- **Formatting**: Ruff format check
- **Linting**: Ruff linting with auto-fix
- **Type checking**: Pyright static analysis

**Example:**

```yaml
name: Quality Checks

on: [push, pull_request]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Format check
        run: uv run ruff format --check .

      - name: Lint
        run: uv run ruff check .

      - name: Type check
        run: uvx pyright packages/
```

### 3. Copilot Setup Workflow

**File:** `.github/workflows/copilot-setup-steps.yml`

**Purpose:** Configure environment for GitHub Copilot coding agent

**Features:**
- Python 3.11 setup
- uv installation and dependency sync
- Environment variable configuration
- Caching for faster runs

**Example:**

```yaml
name: Copilot Setup

on: workflow_dispatch

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 59

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ hashFiles('**/pyproject.toml') }}

      - name: Sync dependencies
        run: uv sync --all-extras

      - name: Verify environment
        run: |
          uv --version
          python --version
          uv pip list
```

---

## Local Testing

### Run Tests Locally (Matches CI)

```bash
# Fast unit tests only
uv run pytest -v -m "not integration and not slow"

# All tests (including integration)
RUN_INTEGRATION=true uv run pytest -v

# With coverage
uv run pytest --cov=packages --cov-report=html --cov-report=term-missing

# Quality checks
uv run ruff format .
uv run ruff check . --fix
uvx pyright packages/
```

### VS Code Tasks

TTA.dev includes VS Code tasks matching CI workflows:

- **ðŸ§ª Run Fast Tests (Unit Only)**: `./scripts/test_fast.sh`
- **ðŸ§ª Run All Tests**: `uv run pytest -v`
- **ðŸ§ª Run Integration Tests (Safe)**: `RUN_INTEGRATION=true ./scripts/test_integration.sh`
- **âœ… Quality Check (All)**: Format, lint, type check, tests

**Run tasks:** `Ctrl+Shift+P` â†’ "Tasks: Run Task" â†’ Select task

---

## Workflow Secrets

### Required Secrets

Configure in GitHub repository settings â†’ Secrets:

| Secret | Purpose | Required For |
|--------|---------|--------------|
| `CODECOV_TOKEN` | Coverage upload | Test workflow |
| `PYPI_TOKEN` | Package publishing | Release workflow |
| `GITHUB_TOKEN` | GitHub API access | Auto-generated by Actions |

### Optional Secrets

| Secret | Purpose | Required For |
|--------|---------|--------------|
| `OPENAI_API_KEY` | LLM testing | Integration tests |
| `REDIS_URL` | Cache testing | Integration tests |

---

## Status Badges

Add to README.md:

```markdown
![Tests](https://github.com/theinterneti/TTA.dev/actions/workflows/test.yml/badge.svg)
![Quality](https://github.com/theinterneti/TTA.dev/actions/workflows/quality.yml/badge.svg)
[![codecov](https://codecov.io/gh/theinterneti/TTA.dev/branch/main/graph/badge.svg)](https://codecov.io/gh/theinterneti/TTA.dev)
```

---

## Caching Strategy

### Dependency Caching

```yaml
- name: Cache uv dependencies
  uses: actions/cache@v4
  with:
    path: ~/.cache/uv
    key: uv-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
    restore-keys: |
      uv-${{ runner.os }}-
```

**Benefits:**
- 10-15s setup time (cached) vs 30-40s (cold)
- Consistent dependency versions
- Reduced PyPI bandwidth

### Build Artifact Caching

```yaml
- name: Cache build artifacts
  uses: actions/cache@v4
  with:
    path: |
      .pytest_cache
      .ruff_cache
      **/__pycache__
    key: build-${{ runner.os }}-${{ github.sha }}
```

---

## Matrix Testing

### Test Multiple Python Versions

```yaml
jobs:
  test:
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Run tests
        run: uv run pytest -v
```

**TTA.dev currently targets:** Python 3.11+ on Linux (primary), macOS/Windows (best effort)

---

## Deployment Workflows

### Package Publishing

**File:** `.github/workflows/publish.yml`

**Trigger:** Push tag matching `v*.*.*` (e.g., `v1.0.0`)

**Steps:**
1. Checkout code
2. Build package with `uv build`
3. Publish to PyPI with `twine upload`

**Example:**

```yaml
name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          pip install twine
          twine upload dist/*
```

### Documentation Deployment

**File:** `.github/workflows/docs.yml`

**Trigger:** Push to `main` branch

**Steps:**
1. Build documentation with Sphinx/MkDocs
2. Deploy to GitHub Pages

---

## Monitoring CI Performance

### Workflow Duration Tracking

```yaml
- name: Track workflow duration
  if: always()
  run: |
    echo "Workflow duration: ${{ job.duration }}s"
    echo "Setup time: ${{ steps.setup.duration }}s"
    echo "Test time: ${{ steps.test.duration }}s"
```

### Optimization Tips

1. **Use caching**: Cache dependencies and build artifacts
2. **Run fast tests first**: Fail fast on unit tests
3. **Parallelize**: Use matrix strategy for independent tests
4. **Skip redundant steps**: Use `if` conditions to skip steps when unnecessary

**Example optimization:**

```yaml
- name: Run integration tests
  if: contains(github.event.head_commit.message, '[integration]')
  run: RUN_INTEGRATION=true uv run pytest -v
```

---

## Debugging Failed Workflows

### Enable Debug Logging

**Method 1: Repository secrets**
- Add secret `ACTIONS_STEP_DEBUG = true`

**Method 2: Re-run with debug**
- Click "Re-run jobs" â†’ "Re-run jobs with debug logging"

### Common Issues

#### Issue 1: Dependency Installation Fails

```
Error: Unable to install package
```

**Solution:** Check `pyproject.toml` for missing dependencies or version conflicts

```bash
# Locally test sync
uv sync --all-extras
```

#### Issue 2: Tests Pass Locally, Fail in CI

```
AssertionError: expected X, got Y
```

**Causes:**
- Environment differences (Python version, OS)
- Missing environment variables
- Race conditions in tests

**Solution:**
```yaml
# Add debugging output
- name: Debug environment
  run: |
    python --version
    uv pip list
    env | sort
```

#### Issue 3: Timeout

```
Error: The operation was canceled.
```

**Solution:** Increase timeout or optimize slow tests

```yaml
jobs:
  test:
    timeout-minutes: 30  # Increase from default 360
```

---

## Best Practices

### 1. Fast Feedback

```yaml
# Run fast checks first
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Lint
        run: uv run ruff check .

  test:
    needs: lint  # Wait for lint to pass
    runs-on: ubuntu-latest
    steps:
      - name: Run tests
        run: uv run pytest -v
```

### 2. Conditional Execution

```yaml
# Skip CI for documentation-only changes
on:
  push:
    paths-ignore:
      - '**.md'
      - 'docs/**'
```

### 3. Manual Approval for Deployments

```yaml
jobs:
  deploy:
    environment:
      name: production
      url: https://tta.dev

    steps:
      - name: Deploy
        run: ./scripts/deploy.sh
```

**Requires:** Repository â†’ Settings â†’ Environments â†’ Add "production" with reviewers

---

## Integration with TTA.dev

### Testing TTA Primitives

```yaml
- name: Test primitives
  run: uv run pytest packages/tta-dev-primitives/tests/ -v

- name: Test observability integration
  run: uv run pytest packages/tta-observability-integration/tests/ -v

- name: Test universal agent context
  run: uv run pytest packages/universal-agent-context/tests/ -v
```

### Observability in CI

```yaml
- name: Start observability services
  run: docker-compose -f docker-compose.test.yml up -d

- name: Run integration tests with tracing
  env:
    OTEL_EXPORTER_OTLP_ENDPOINT: http://localhost:4318
  run: uv run pytest tests/integration/ -v

- name: Stop services
  if: always()
  run: docker-compose -f docker-compose.test.yml down
```

---

## Related Documentation

- [[TTA.dev/CI-CD Pipeline]] - Complete CI/CD documentation
- [[TTA.dev/Testing]] - Testing strategies
- [[TTA.dev/Deployment]] - Deployment procedures

---

## Related Topics

- [[GitHub]] - Version control and collaboration
- [[Docker]] - Containerization for CI services
- [[Python]] - Primary language

---

## External Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GitHub Actions Marketplace](https://github.com/marketplace?type=actions)
- [uv Documentation](https://docs.astral.sh/uv/)
- [pytest Documentation](https://docs.pytest.org/)

---

**CI Status:** ![Tests](https://github.com/theinterneti/TTA.dev/actions/workflows/test.yml/badge.svg)
**Coverage:** [![codecov](https://codecov.io/gh/theinterneti/TTA.dev/branch/main/graph/badge.svg)](https://codecov.io/gh/theinterneti/TTA.dev)
