name: 'ðŸšª Merge Gate'

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'logseq/**'
      - 'archive/**'

concurrency:
  group: merge-gate-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHONUNBUFFERED: 1
  UV_CACHE_DIR: ~/.cache/uv

jobs:
  comprehensive-tests:
    name: 'Comprehensive Test Suite'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 'âš™ï¸ Setup TTA environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: ${{ matrix.python-version }}

      - name: 'ðŸ“¦ Cache comprehensive dependencies'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-deps-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            uv-deps-${{ runner.os }}-py${{ matrix.python-version }}-
            uv-deps-${{ runner.os }}-

      - name: 'ðŸ”§ Sync all dependencies'
        run: uv sync --all-extras

      - name: 'ðŸ§ª Run comprehensive tests'
        run: |
          echo "ðŸ§ª Running comprehensive test suite..."
          uv run pytest -v \
            --cov=packages \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -m "not integration" \
            --durations=10 \
            --tb=short

      - name: 'ðŸ“¤ Upload coverage'
        if: always() && matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: comprehensive-tests,ubuntu,python-${{ matrix.python-version }}
          name: comprehensive-coverage-py${{ matrix.python-version }}
          fail_ci_if_error: false
          verbose: false

      - name: 'ðŸ“Š Upload detailed coverage'
        if: always() && matrix.python-version == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-comprehensive
          path: htmlcov/
          retention-days: 7

      - name: 'ðŸ“Š Test timing analysis'
        if: always() && matrix.python-version == '3.12'
        run: |
          echo "## ðŸ§ª Test Performance Analysis (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          uv run pytest -v --durations=10 --durations-min=1.0 -q 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "No performance data available" >> $GITHUB_STEP_SUMMARY

  integration-tests:
    name: 'Integration Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: comprehensive-tests

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass123
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'âš™ï¸ Setup TTA environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ðŸ“¦ Restore uv cache'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-deps-${{ runner.os }}-py312-${{ hashFiles('uv.lock', 'pyproject.toml') }}

      - name: 'ðŸ”§ Sync dependencies'
        run: uv sync --all-extras

      - name: 'ðŸ—„ï¸ Setup integration test environment'
        run: |
          echo "ðŸ—„ï¸ Setting up integration test database..."
          # Wait for PostgreSQL to be ready
          until pg_isready -h localhost -p 5432; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "âœ… PostgreSQL is ready"

      - name: 'ðŸ”— Run integration tests'
        run: |
          echo "ðŸ”— Running integration tests..."
          uv run pytest -v \
            -m "integration" \
            --maxfail=3 \
            --tb=short \
            -x
        env:
          DATABASE_URL: postgresql://postgres:testpass123@localhost:5432/testdb
          RUN_INTEGRATION: "true"

  cross-platform-compatibility:
    name: 'Cross-Platform Compatibility'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: comprehensive-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
        python-version: ['3.12']

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'âš™ï¸ Setup TTA environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: ${{ matrix.python-version }}

      - name: 'ðŸ“¦ Cache platform-specific dependencies'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-deps-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            uv-deps-${{ runner.os }}-py${{ matrix.python-version }}-
            uv-deps-${{ runner.os }}-

      - name: 'ðŸ”§ Sync dependencies'
        run: uv sync --all-extras --no-install-project

      - name: 'ðŸ” Run platform compatibility tests'
        run: |
          echo "ðŸ” Running platform compatibility tests..."
          uv run pytest -v \
            -m "not slow and not external and not integration" \
            --maxfail=5 \
            --tb=line \
            --durations=0

  quality-validation:
    name: 'Quality Validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [comprehensive-tests, integration-tests]

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'âš™ï¸ Setup TTA environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ðŸ“¦ Restore uv cache'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-deps-${{ runner.os }}-py312-${{ hashFiles('uv.lock', 'pyproject.toml') }}

      - name: 'ðŸ”§ Sync dependencies'
        run: uv sync --all-extras --no-install-project

      - name: 'ðŸ”’ Advanced security validation'
        run: |
          echo "ðŸ”’ Running comprehensive security audit..."
          uvx pip-audit --format json > security-audit.json || true
          uvx safety check --output json > safety-audit.json || true
          echo "âœ… Security audits completed"

      - name: 'ðŸ“¦ Production package validation'
        run: |
          echo "ðŸ“¦ Building production packages..."
          for package in packages/*/pyproject.toml; do
            dir=$(dirname $package)
            echo "ðŸ“¦ Building $dir..."
            (
              cd $dir
              uv build
              echo "âœ… $dir production build passed"
            ) || (
              echo "âŒ $dir production build failed" >&2
              exit 1
            )
          done

      - name: 'ðŸ” Validation summary'
        if: always()
        run: |
          echo "## ðŸšª Merge Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Comprehensive unit tests (Python 3.11, 3.12)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Integration tests with database" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cross-platform compatibility (macOS, Windows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security audits completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Production builds validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… **All Merge Gates Passed!**" >> $GITHUB_STEP_SUMMARY
          echo "Ready for production deployment." >> $GITHUB_STEP_SUMMARY
