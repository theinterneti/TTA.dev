name: Agentic Self-Healing CI

on:
    workflow_dispatch:
    # pull_request: # Uncomment to enable on PRs
    #   branches: [ main ]

jobs:
    self-heal:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install uv
              run: curl -LsSf https://astral.sh/uv/install.sh | sh

            - name: Install dependencies
              run: uv sync --all-extras

            - name: Install Gemini CLI
              run: npm install -g @google/gemini-cli

            - name: Run Self-Healing Tests
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  TTA_AGENT_RUNTIME: gemini
              run: python scripts/ci_self_heal.py --max-attempts 2

            - name: Commit Fixes
              if: success()
              run: |
                  git config --global user.name "TTA Agent"
                  git config --global user.email "agent@tta.dev"
                  git add .
                  git diff --staged --quiet || git commit -m "fix: Auto-fix test failures via Agentic Self-Healing"
                  git push
