name: KB Validation

permissions:
  contents: read

on:
  pull_request:
    branches:
      - main
      - 'kb/**'
    paths:
      - 'logseq/**'
      - 'packages/tta-kb-automation/**'
      - 'scripts/kb-*.sh'
      - '.github/workflows/kb-validation.yml'
  push:
    branches:
      - main
      - 'kb/**'
    paths:
      - 'logseq/**'
      - 'packages/tta-kb-automation/**'
  schedule:
    # Run daily at 3 AM UTC to catch drift
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  kb-link-validation:
    name: Validate KB Links
    permissions:
      contents: read
      issues: write
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install tta-kb-automation
        run: |
          uv sync --all-extras
          uv pip install -e packages/tta-kb-automation

      - name: Run LinkValidator
        run: |
          uv run python -c "
          import asyncio
          from pathlib import Path
          from tta_kb_automation import ParseLogseqPages, ExtractLinks, ValidateLinks, WorkflowContext

          async def main():
              context = WorkflowContext(workflow_id='ci-link-validation')
              kb_root = Path('logseq')

              # Step 1: Parse pages
              parser = ParseLogseqPages()
              parse_result = await parser.execute({'kb_root': kb_root}, context)

              # Step 2: Extract links
              extractor = ExtractLinks()
              links_result = await extractor.execute({'pages': parse_result['pages']}, context)

              # Step 3: Validate links
              validator = ValidateLinks()
              result = await validator.execute({
                  'pages': parse_result['pages'],
                  'links': links_result['links']
              }, context)

              broken = result['broken_links']
              valid_count = result.get('valid_links', 0)

              # Generate report file for PR comments
              with open('kb-validation-report.md', 'w') as f:
                  f.write('# KB Link Validation Report\n\n')
                  f.write(f'**Valid Links:** {valid_count}\n')
                  f.write(f'**Broken Links:** {len(broken)}\n\n')
                  if broken:
                      f.write('## Broken Links\n\n')
                      for link in broken:
                          f.write(f'- {link[\"source\"]} -> {link[\"target\"]} (missing)\n')

              if broken:
                  print(f'âŒ Found {len(broken)} broken links:')
                  for link in broken[:10]:
                      print(f'  - {link[\"source\"]} -> {link[\"target\"]} (missing)')
                  if len(broken) > 10:
                      print(f'  ... and {len(broken) - 10} more')
                  exit(1)
              else:
                  print(f'âœ… All {valid_count} links valid')

          asyncio.run(main())
          "

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kb-validation-report
          path: kb-validation-report.md
          retention-days: 30

      - name: Comment on PR with results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('kb-validation-report.md', 'utf8');
            const summary = report.split('\n').slice(0, 50).join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ KB Validation Failed\n\n${summary}\n\nSee full report in artifacts.`
            });

  kb-orphan-detection:
    name: Detect Orphaned Pages
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install tta-kb-automation
        run: |
          uv sync --all-extras
          uv pip install -e packages/tta-kb-automation

      - name: Find orphaned pages
        run: |
          uv run python -c "
          import asyncio
          from pathlib import Path
          from tta_kb_automation import ParseLogseqPages, ExtractLinks, FindOrphanedPages, WorkflowContext

          async def main():
              context = WorkflowContext(workflow_id='ci-orphan-check')
              kb_root = Path('logseq')

              # Step 1: Parse pages
              parser = ParseLogseqPages()
              parse_result = await parser.execute({'kb_root': kb_root}, context)

              # Step 2: Extract links
              extractor = ExtractLinks()
              links_result = await extractor.execute({'pages': parse_result['pages']}, context)

              # Step 3: Find orphaned pages
              finder = FindOrphanedPages()
              result = await finder.execute({
                  'pages': parse_result['pages'],
                  'links': links_result['links']
              }, context)

              orphans = result['orphaned_pages']
              if orphans:
                  print(f'âš ï¸  Found {len(orphans)} orphaned pages:')
                  for page in orphans[:10]:
                      print(f'  - {page[\"title\"]}')
                  if len(orphans) > 10:
                      print(f'  ... and {len(orphans) - 10} more')
              else:
                  print('âœ… No orphaned pages found')

          asyncio.run(main())
          "

  kb-structure-validation:
    name: Validate KB Structure
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required KB pages exist
        run: |
          # Check for critical KB pages
          required_pages=(
            "logseq/pages/TODO Management System.md"
            "logseq/pages/TTA.dev___TODO Architecture.md"
            "logseq/pages/TODO Templates.md"
          )

          missing=()
          for page in "${required_pages[@]}"; do
            if [ ! -f "$page" ]; then
              missing+=("$page")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "âŒ Missing required KB pages:"
            printf '  - %s\n' "${missing[@]}"
            exit 1
          else
            echo "âœ… All required KB pages present"
          fi

      - name: Validate journal structure
        run: |
          # Check that journals directory exists (or is intentionally excluded for privacy)
          if [ ! -d "logseq/journals" ]; then
            if grep -q "logseq/journals" .gitignore 2>/dev/null; then
              echo "â„¹ï¸  logseq/journals excluded for privacy (.gitignore)"
              echo "âœ… KB structure valid (journals excluded by design)"
              exit 0
            else
              echo "âŒ logseq/journals directory not found and not in .gitignore"
              exit 1
            fi
          fi

          journal_count=$(find logseq/journals -name "*.md" | wc -l)
          if [ "$journal_count" -eq 0 ]; then
            echo "âš ï¸  No journal entries found (empty directory)"
          else
            echo "âœ… Found $journal_count journal entries"
          fi

  kb-todo-sync:
    name: KB TODO Sync Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install tta-kb-automation
        run: |
          uv sync --all-extras
          uv pip install -e packages/tta-kb-automation

      - name: Check for new TODOs in code
        run: |
          # Get changed Python files
          git diff --name-only origin/main...HEAD | grep '\.py$' > changed_files.txt || true

          if [ ! -s changed_files.txt ]; then
            echo "No Python files changed, skipping TODO sync check"
            exit 0
          fi

          echo "Checking for TODOs in changed files:"
          cat changed_files.txt

          # Run TODO extraction on changed files
          uv run python -c "
          import asyncio
          from pathlib import Path
          from tta_kb_automation import ExtractTODOs, WorkflowContext

          async def main():
              changed_files = Path('changed_files.txt').read_text().strip().split('\n')
              changed_files = [f for f in changed_files if f]

              if not changed_files:
                  print('No files to check')
                  return

              extractor = ExtractTODOs()
              context = WorkflowContext(workflow_id='ci-todo-check')

              # ExtractTODOs expects {'files': [list of paths]}
              result = await extractor.execute({'files': changed_files}, context)
              all_todos = result['todos']

              if all_todos:
                  print(f'âš ï¸  Found {len(all_todos)} TODOs in changed files:')
                  for todo in all_todos[:5]:
                      print(f'  - {todo[\"file\"]}:{todo[\"line_number\"]}: {todo[\"todo_text\"][:60]}...')
                  if len(all_todos) > 5:
                      print(f'  ... and {len(all_todos) - 5} more')
                  print('')
                  print('ðŸ’¡ Consider syncing these TODOs to today\\'s journal entry.')
              else:
                  print('âœ… No TODOs found in changed files')

          asyncio.run(main())
          "

  kb-metrics:
    name: KB Metrics Report
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install tta-kb-automation
        run: |
          uv sync --all-extras
          uv pip install -e packages/tta-kb-automation

      - name: Generate KB metrics
        run: |
          uv run python -c "
          import asyncio
          from pathlib import Path
          from tta_kb_automation import ParseLogseqPages, WorkflowContext

          async def main():
              parser = ParseLogseqPages(kb_root=Path('logseq'))
              context = WorkflowContext(workflow_id='ci-metrics')
              result = await parser.execute({}, context)

              pages = result['pages']
              print('# KB Metrics Report')
              print('')
              print(f'- Total pages: {len(pages)}')
              print(f'- Total journals: {len([p for p in pages if \"journals\" in str(p)])}')
              print(f'- Total knowledge pages: {len([p for p in pages if \"journals\" not in str(p)])}')
              print('')

              # Category breakdown
              categories = {}
              for page in pages:
                  if 'journals' in str(page):
                      continue
                  parts = page.stem.split('___')
                  if len(parts) > 1:
                      category = parts[0]
                      categories[category] = categories.get(category, 0) + 1

              if categories:
                  print('## Knowledge Pages by Category')
                  print('')
                  for cat, count in sorted(categories.items(), key=lambda x: x[1], reverse=True):
                      print(f'- {cat}: {count} pages')

          asyncio.run(main())
          "

      - name: Post metrics to summary
        if: always()
        run: |
          echo "## KB Metrics" >> $GITHUB_STEP_SUMMARY
          uv run python -c "
          import asyncio
          from pathlib import Path
          from tta_kb_automation import ParseLogseqPages, WorkflowContext

          async def main():
              parser = ParseLogseqPages(kb_root=Path('logseq'))
              context = WorkflowContext(workflow_id='ci-metrics')
              result = await parser.execute({}, context)

              pages = result['pages']
              print(f'- **Total pages:** {len(pages)}')
              print(f'- **Journals:** {len([p for p in pages if \"journals\" in str(p)])}')
              print(f'- **Knowledge pages:** {len([p for p in pages if \"journals\" not in str(p)])}')

          asyncio.run(main())
          " >> $GITHUB_STEP_SUMMARY
