name: 'ğŸ”„ Fallback AI Code Review'

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number to review'
        required: true
        type: string

concurrency:
  group: ai-review-${{ inputs.pr_number }}
  cancel-in-progress: true

jobs:
  fallback-review:
    name: 'Cline AI Review Fallback'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 'ğŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'ğŸ” Check for Gemini reviews'
        id: check-reviews
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Checking for existing Gemini reviews on PR #${{ inputs.pr_number }}..."

          # Check if there are recent reviews from GitHub Actions (Gemini bot)
          REVIEWS=$(gh pr view ${{ inputs.pr_number }} --json reviews -q '.reviews | map(select(.author.login | contains("github-actions"))) | length')

          echo "gemini-reviews-count=$REVIEWS" >> $GITHUB_OUTPUT

          if [ "$REVIEWS" -gt 0 ]; then
            echo "âœ… Gemini review found, no fallback needed"
            echo "needs-fallback=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No Gemini review found, activating fallback"
            echo "needs-fallback=true" >> $GITHUB_OUTPUT
          fi

      - name: 'ğŸ’¬ Post fallback review comment'
        if: steps.check-reviews.outputs.needs-fallback == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ’¬ Posting fallback AI review comment..."

          COMMENT="## ğŸ¤– Fallback AI Code Review

ğŸ”„ **Gemini AI review encountered issues** and fell back to basic automated validation.

### âš ï¸ **Limited Analysis Available**

Due to external AI service unavailability, this is a basic automated review. Please ensure:

- Manual code review by a team member  
- Local testing and validation
- Security impact assessment

### ğŸ“‹ **Manual Review Checklist**
- [ ] Code logic is sound and handles edge cases
- [ ] Security vulnerabilities addressed  
- [ ] Performance optimizations considered
- [ ] Documentation updated appropriately
- [ ] Tests added/modified as needed

### ğŸ”§ **Recommended Actions**
1. **Immediate**: Address any critical issues found in CI checks
2. **Short-term**: Verify Gemini AI service connectivity  
3. **Long-term**: Consider local AI review alternatives

---
*Generated by fallback review workflow - $(date)*"

          # Post the comment
          echo "$COMMENT" | gh pr comment ${{ inputs.pr_number }} --body-file -
          echo "âœ… Fallback review comment posted"
