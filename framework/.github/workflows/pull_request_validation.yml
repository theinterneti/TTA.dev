name: 'ðŸ” Pull Request Validation'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'logseq/**'
      - 'archive/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'

concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: 1
  UV_CACHE_DIR: ~/.cache/uv

jobs:
  validate-pr:
    name: 'PR Validation Suite'
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'âš™ï¸ Setup TTA environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ðŸ“¦ Cache uv dependencies'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-deps-${{ runner.os }}-py312-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            uv-deps-${{ runner.os }}-py312-
            uv-deps-${{ runner.os }}-

      - name: 'ðŸ”§ Sync dependencies'
        run: uv sync --all-extras --no-install-project

      - name: 'ðŸ” Format check'
        id: format-check
        run: |
          echo "ðŸ” Running Ruff format check..."
          if uv run ruff format --check .; then
            echo "âœ… Code formatting is valid"
          else
            echo "âŒ Code formatting issues found" >&2
            exit 1
          fi

      - name: 'ðŸ§¹ Lint check'
        id: lint-check
        run: |
          echo "ðŸ§¹ Running Ruff lint check..."
          if uv run ruff check .; then
            echo "âœ… Code linting passed"
          else
            echo "âŒ Code linting issues found" >&2
            exit 1
          fi

      - name: 'ðŸ” Type check'
        id: type-check
        run: |
          echo "ðŸ” Running Pyright type check..."
          if uv run pyright packages/; then
            echo "âœ… Type checking passed"
          else
            echo "âŒ Type checking failed" >&2
            exit 1
          fi

      - name: 'ðŸ§ª Unit tests'
        id: unit-tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          if uv run pytest -v -m "not integration and not slow and not external" --maxfail=5 --tb=short; then
            echo "âœ… Unit tests passed"
          else
            echo "âŒ Unit tests failed" >&2
            exit 1
          fi

      - name: 'ðŸ“ Validation summary'
        if: always()
        run: |
          echo "## ðŸ” Pull Request Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Time |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Format | ${{ steps.format-check.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ${{ steps.format-check.conclusion != 'skipped' && format('~{0}s', steps.format-check.outputs.duration || 'N/A') || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§¹ Lint | ${{ steps.lint-check.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ${{ steps.lint-check.conclusion != 'skipped' && format('~{0}s', steps.lint-check.outputs.duration || 'N/A') || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Type Check | ${{ steps.type-check.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ${{ steps.type-check.conclusion != 'skipped' && format('~{0}s', steps.type-check.outputs.duration || 'N/A') || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | ${{ steps.unit-tests.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ${{ steps.unit-tests.conclusion != 'skipped' && format('~{0}s', steps.unit-tests.outputs.duration || 'N/A') || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.format-check.outcome }}" == "success" ] && [ "${{ steps.lint-check.outcome }}" == "success" ] && [ "${{ steps.type-check.outcome }}" == "success" ] && [ "${{ steps.unit-tests.outcome }}" == "success" ]; then
            echo "âœ… **All checks passed!** Ready for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some checks failed.** Please review the issues above." >> $GITHUB_STEP_SUMMARY
          fi

  validate-quality:
    name: 'Quality Assurance'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: validate-pr

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'âš™ï¸ Setup TTA environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ðŸ“¦ Restore uv cache'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-deps-${{ runner.os }}-py312-${{ hashFiles('uv.lock', 'pyproject.toml') }}

      - name: 'ðŸ”§ Sync dependencies'
        run: uv sync --all-extras --no-install-project

      - name: 'ðŸ“Š Code coverage'
        id: coverage
        run: |
          echo "ðŸ“Š Running tests with coverage..."
          uv run pytest -m "not integration and not slow and not external" --cov=packages --cov-branch --cov-report=xml --cov-report=term-missing
          echo "âœ… Coverage analysis completed"

      - name: 'ðŸ“¤ Upload coverage'
        if: always()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: pr-validation
          name: pr-validation-coverage
          fail_ci_if_error: false
          verbose: false

      - name: 'ðŸ”’ Security scan'
        id: security
        run: |
          echo "ðŸ”’ Running security audit..."
          # Use continue-on-error to avoid blocking PRs due to false positives
          if uv run pip-audit --format text > security-audit.txt 2>&1; then
            echo "âœ… Security audit completed without critical issues"
          else
            echo "âš ï¸ Security audit found potential issues (review security-audit.txt)"
          fi
        continue-on-error: true

      - name: 'ðŸ“¦ Package validation'
        id: package-check
        run: |
          echo "ðŸ“¦ Validating package builds..."
          for package in packages/*/pyproject.toml; do
            dir=$(dirname $package)
            echo "ðŸ“¦ Checking $dir..."
            (
              cd $dir && uv build --check
              echo "âœ… $dir build check passed"
            ) || (
              echo "âŒ $dir build check failed" >&2
              exit 1
            )
          done
          echo "âœ… All packages validated successfully"

      - name: 'ðŸ“ Quality summary'
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Quality Assurance Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Coverage report uploaded to Codecov" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Package validation: ${{ steps.package-check.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Audit: ${{ steps.security.outcome == 'success' && 'âœ… Clean' || 'âš ï¸ Issues found' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "â€¢ Review Codecov report for coverage gaps" >> $GITHUB_STEP_SUMMARY
          if [ -f security-audit.txt ]; then
            echo "â€¢ Check security-audit.txt for details" >> $GITHUB_STEP_SUMMARY
          fi
