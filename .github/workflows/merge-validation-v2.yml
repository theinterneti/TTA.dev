name: Merge Validation v2 (Parallel Execution)

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'logseq/**'
      - 'archive/**'

jobs:
  quality-checks:
    name: Quality Checks
    uses: ./.github/workflows/reusable-quality-checks.yml
    with:
      python-version: '3.11'
      check-format: true
      check-lint: true
      check-types: true
      fail-on-type-errors: false

  comprehensive-tests:
    name: Comprehensive Tests
    uses: ./.github/workflows/reusable-run-tests.yml
    with:
      test-type: 'unit'
      python-versions: '["3.11", "3.12"]'
      coverage: true
      pytest-markers: 'not integration and not slow'
      timeout-minutes: 15
      upload-coverage: true

  integration-tests:
    name: Integration Tests
    needs: comprehensive-tests
    uses: ./.github/workflows/reusable-run-tests.yml
    with:
      test-type: 'integration'
      python-versions: '["3.11"]'
      coverage: false
      pytest-markers: 'integration and not slow'
      timeout-minutes: 10

  build-primitives:
    name: Build tta-dev-primitives
    needs: [quality-checks, comprehensive-tests]
    uses: ./.github/workflows/reusable-build-package.yml
    with:
      package-path: 'packages/tta-dev-primitives'
      python-version: '3.11'
      upload-artifact: true
      validate-manifest: true

  quality-gates:
    name: Quality Gates
    needs: [quality-checks, comprehensive-tests, integration-tests, build-primitives]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs
        run: |
          echo "## ðŸŽ¯ Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Comprehensive Tests | ${{ needs.comprehensive-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Package | ${{ needs.build-primitives.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all required jobs passed
          if [ "${{ needs.quality-checks.result }}" == "success" ] && \
             [ "${{ needs.comprehensive-tests.result }}" == "success" ] && \
             [ "${{ needs.integration-tests.result }}" == "success" ] && \
             [ "${{ needs.build-primitives.result }}" == "success" ]; then
            echo "### âœ… All Quality Gates Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The code is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Quality Gates Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some jobs did not complete successfully. Please review." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
