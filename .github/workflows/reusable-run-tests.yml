name: Run Tests

on:
  workflow_call:
    inputs:
      test-type:
        description: 'Type of tests to run (unit/integration/all)'
        required: true
        type: string
      python-versions:
        description: 'Python versions as JSON array (e.g., ["3.11", "3.12"])'
        required: false
        default: '["3.11"]'
        type: string
      coverage:
        description: 'Enable coverage reporting'
        required: false
        default: false
        type: boolean
      pytest-markers:
        description: 'Pytest markers to use (-m argument)'
        required: false
        default: ''
        type: string
      timeout-minutes:
        description: 'Test timeout in minutes'
        required: false
        default: 10
        type: number
      upload-coverage:
        description: 'Upload coverage to Codecov'
        required: false
        default: false
        type: boolean
    outputs:
      test-result:
        description: 'Test execution result (success/failure)'
        value: ${{ jobs.test.result }}

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TTA environment
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: ${{ matrix.python-version }}

      - name: Sync dependencies
        run: uv sync --all-extras

      - name: Start Docker services (integration tests only)
        if: inputs.test-type == 'integration' || inputs.test-type == 'all'
        run: |
          echo "Starting Docker Compose services..."
          docker compose -f platform/primitives/docker-compose.integration.yml up -d
          echo "Waiting for services to be ready..."
          sleep 10

      - name: Run unit tests
        if: inputs.test-type == 'unit' || inputs.test-type == 'all'
        env:
          PYTHONPATH: ${{ github.workspace }}/packages
        run: |
          if [ "${{ inputs.coverage }}" == "true" ]; then
            echo "Running unit tests with coverage..."
            if [ -n "${{ inputs.pytest-markers }}" ]; then
              uv run pytest -v -m "${{ inputs.pytest-markers }}" \
                --cov=packages --cov-report=xml --cov-report=term-missing \
                --cov-report=html
            else
              uv run pytest -v -m "not integration and not slow" \
                --cov=packages --cov-report=xml --cov-report=term-missing \
                --cov-report=html
            fi
          else
            echo "Running unit tests without coverage..."
            if [ -n "${{ inputs.pytest-markers }}" ]; then
              uv run pytest -v -m "${{ inputs.pytest-markers }}"
            else
              uv run pytest -v -m "not integration and not slow"
            fi
          fi

      - name: Run integration tests
        if: inputs.test-type == 'integration' || inputs.test-type == 'all'
        env:
          RUN_INTEGRATION: "true"
          PYTHONPATH: ${{ github.workspace }}/packages
        run: |
          echo "Running integration tests..."
          if [ -n "${{ inputs.pytest-markers }}" ]; then
            uv run pytest -v -m "${{ inputs.pytest-markers }}"
          else
            uv run pytest -v -m "integration"
          fi

      - name: Stop Docker services
        if: always() && (inputs.test-type == 'integration' || inputs.test-type == 'all')
        run: |
          echo "Stopping Docker Compose services..."
          docker compose -f platform/primitives/docker-compose.integration.yml down

      - name: Upload coverage report (HTML)
        if: inputs.coverage && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: htmlcov/
          retention-days: 7

      - name: Upload coverage report (XML)
        if: inputs.coverage && inputs.upload-coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: python-${{ matrix.python-version }}
          name: Python ${{ matrix.python-version }}
          fail_ci_if_error: false

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Type:** ${{ inputs.test-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage Enabled:** ${{ inputs.coverage }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.pytest-markers }}" ]; then
            echo "- **Pytest Markers:** \`${{ inputs.pytest-markers }}\`" >> $GITHUB_STEP_SUMMARY
          fi
