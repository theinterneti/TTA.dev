name: 'â° Scheduled Weekly Secret Rotation'

on:
  schedule:
    # Run every Monday at 2 AM PST (10:00 UTC) for weekly rotation
    - cron: '0 10 * * 1'
  workflow_dispatch:
    inputs:
      emergency_rotation:
        description: 'Emergency rotation - bypass normal schedules'
        required: false
        type: boolean
        default: false
      services_override:
        description: 'Override services to rotate (comma-separated)'
        required: false
        type: string
        default: ''

concurrency:
  group: 'weekly-secret-rotation'
  cancel-in-progress: false

env:
  PYTHONUNBUFFERED: 1
  TZ: America/Los_Angeles

jobs:
  assess-rotation-readiness:
    name: 'ðŸ” Assess Rotation Readiness'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      should_rotate: ${{ steps.readiness.outputs.should_rotate }}
      rotation_reasons: ${{ steps.readiness.outputs.rotation_reasons }}
      risk_level: ${{ steps.readiness.outputs.risk_level }}
      correlation_id: ${{ steps.generate-id.outputs.correlation_id }}

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4

      - name: 'ðŸ”¢ Generate weekly correlation ID'
        id: generate-id
        run: |
          week_number=$(date +%U)
          year=$(date +%Y)
          correlation_id="weekly-${year}W${week_number}-$(echo $RANDOM | md5sum | head -c 6)"
          echo "correlation_id=${correlation_id}" >> $GITHUB_OUTPUT
          echo "ðŸ“… Weekly rotation ID: ${correlation_id}"

      - name: 'âš™ï¸ Setup Python environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ðŸ“Š Assess rotation readiness'
        id: readiness
        env:
          CORRELATION_ID: ${{ steps.generate-id.outputs.correlation_id }}
          EMERGENCY_MODE: ${{ github.event.inputs.emergency_rotation || 'false' }}
        run: |
          echo "ðŸ” Assessing rotation readiness..."

          # Default weekly rotation settings
          should_rotate="true"
          rotation_reasons="scheduled_weekly_rotation"
          risk_level="low"

          # Check for emergency override
          if [ "$EMERGENCY_MODE" = "true" ]; then
            echo "ðŸš¨ EMERGENCY ROTATION MODE ACTIVATED"
            should_rotate="true"
            rotation_reasons="emergency_rotation_override"
            risk_level="high"
          fi

          # Check recent rotation history (would query GitHub API)
          echo "ðŸ“ˆ Checking recent rotation history..."

          # Check system health metrics
          echo "ðŸ¥ Checking system health status..."

          # Determine if high-risk services need rotation
          echo "ðŸŽ¯ Evaluating service rotation priorities..."

          echo "should_rotate=${should_rotate}" >> $GITHUB_OUTPUT
          echo "rotation_reasons=${rotation_reasons}" >> $GITHUB_OUTPUT
          echo "risk_level=${risk_level}" >> $GITHUB_OUTPUT

      - name: 'ðŸ“ Weekly rotation initiation log'
        run: |
          echo "## â° Weekly Secret Rotation Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Correlation ID:** ${{ steps.generate-id.outputs.correlation_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Risk Level:** ${{ steps.readiness.outputs.risk_level }}" >> $GITHUB_STEP_SUMMARY
          echo "**Emergency Mode:** ${{ github.event.inputs.emergency_rotation || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.readiness.outputs.should_rotate }}" = "true" ]; then
            echo "### ðŸŽ¯ Rotation Plan" >> $GITHUB_STEP_SUMMARY
            echo "- Scheduled Services: gemini, github, e2b, codecov" >> $GITHUB_STEP_SUMMARY
            echo "- High-Risk Services: gcp (monthly only)" >> $GITHUB_STEP_SUMMARY
            echo "- Validation: Full post-rotation testing" >> $GITHUB_STEP_SUMMARY
            echo "- Monitoring: 72-hour observation window" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â¸ï¸ Rotation Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Reason: ${{ steps.readiness.outputs.rotation_reasons }}" >> $GITHUB_STEP_SUMMARY
          fi

  execute-weekly-rotation:
    name: 'ðŸ”„ Execute Weekly Rotation'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: assess-rotation-readiness
    if: needs.assess-rotation-readiness.outputs.should_rotate == 'true'

    strategy:
      fail-fast: false
      matrix:
        service: [
          {name: 'gemini', priority: 1, weekly_rotation: true},
          {name: 'github', priority: 2, weekly_rotation: true},
          {name: 'e2b', priority: 3, weekly_rotation: true},
          {name: 'codecov', priority: 4, weekly_rotation: true}
        ]

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Python environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ðŸ”„ Execute weekly rotation for ${{ matrix.service.name }}'
        id: weekly-rotate
        env:
          CORRELATION_ID: ${{ needs.assess-rotation-readiness.outputs.correlation_id }}
          SERVICE_NAME: ${{ matrix.service.name }}
          ROTATION_TYPE: 'weekly'
          RISK_LEVEL: ${{ needs.assess-rotation-readiness.outputs.risk_level }}
          SERVICE_PRIORITY: ${{ matrix.service.priority }}
          EMERGENCY_MODE: ${{ github.event.inputs.emergency_rotation || 'false' }}
          SERVICES_OVERRIDE: ${{ github.event.inputs.services_override }}
          # Service credentials
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_PERSONAL_ACCESS_TOKEN: ${{ secrets.GITHUB_PERSONAL_ACCESS_TOKEN }}
          E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â° Executing weekly rotation for ${SERVICE_NAME}..."

          # Create weekly audit directory
          mkdir -p weekly-audit-logs

          # Execute rotation
          case $SERVICE_NAME in
            gemini)
              python scripts/rotate_secrets.py gemini-rotate
              ;;
            github)
              python scripts/rotate_secrets.py github-rotate
              ;;
            e2b)
              python scripts/rotate_secrets.py e2b-rotate
              ;;
            codecov)
              python scripts/rotate_secrets.py codecov-rotate
              ;;
            *)
              echo "âŒ Unknown service for weekly rotation: $SERVICE_NAME"
              exit 1
              ;;
          esac

          if [ $? -eq 0 ]; then
            echo "rotation_success=true" >> $GITHUB_OUTPUT
            echo "âœ… ${SERVICE_NAME} weekly rotation completed successfully"
          else
            echo "rotation_success=false" >> $GITHUB_OUTPUT
            echo "âŒ ${SERVICE_NAME} weekly rotation failed"
            exit 1
          fi

      - name: 'ðŸ” Validate weekly rotation'
        if: steps.weekly-rotate.outputs.rotation_success == 'true'
        env:
          SERVICE_NAME: ${{ matrix.service.name }}
        run: |
          echo "ðŸ” Validating weekly rotation for ${SERVICE_NAME}..."

          case $SERVICE_NAME in
            gemini)
              python scripts/validate_rotated_secret.py gemini-test
              ;;
            github)
              python scripts/validate_rotated_secret.py github-test
              ;;
            e2b)
              python scripts/validate_rotated_secret.py e2b-test
              ;;
          esac

          if [ $? -eq 0 ]; then
            echo "âœ… ${SERVICE_NAME} validation passed"
          else
            echo "âŒ ${SERVICE_NAME} validation failed"
            exit 1
          fi

      - name: 'ðŸ“¤ Upload weekly rotation artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-rotation-audit-${{ matrix.service.name }}-${{ needs.assess-rotation-readiness.outputs.correlation_id }}
          path: |
            weekly-audit-logs/
            audit-logs/
          retention-days: 30

  monthly-gcp-rotation:
    name: 'ðŸ¢ Monthly GCP Key Rotation'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: assess-rotation-readiness
    # Only run GCP rotation if it's the 1st week of the month or emergency mode
    if: >
      (needs.assess-rotation-readiness.outputs.should_rotate == 'true' &&
       (contains(needs.assess-rotation-readiness.outputs.correlation_id, 'W01') ||
        contains(needs.assess-rotation-readiness.outputs.correlation_id, 'emergency')))

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Python environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ðŸ¢ Execute GCP monthly rotation'
        id: gcp-monthly-rotate
        env:
          CORRELATION_ID: ${{ needs.assess-rotation-readiness.outputs.correlation_id }}
          SERVICE_NAME: 'gcp'
          ROTATION_TYPE: 'monthly'
          RISK_LEVEL: ${{ needs.assess-rotation-readiness.outputs.risk_level }}
          SERVICE_PRIORITY: 5
          EMERGENCY_MODE: ${{ github.event.inputs.emergency_rotation || 'false' }}
          # GCP-specific credentials
          GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          GOOGLE_CLOUD_LOCATION: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
          SERVICE_ACCOUNT_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ¢ Executing monthly GCP rotation..."

          # Create monthly audit directory
          mkdir -p monthly-audit-logs

          # Execute GCP rotation
          python scripts/rotate_secrets.py gcp-rotate

          if [ $? -eq 0 ]; then
            echo "gcp_rotation_success=true" >> $GITHUB_OUTPUT
            echo "âœ… GCP monthly rotation completed successfully"
          else
            echo "gcp_rotation_success=false" >> $GITHUB_OUTPUT
            echo "âŒ GCP monthly rotation failed"
            exit 1
          fi

      - name: 'ðŸ” Validate GCP rotation'
        if: steps.gcp-monthly-rotate.outputs.gcp_rotation_success == 'true'
        run: |
          echo "ðŸ” Validating GCP rotation..."
          python scripts/validate_rotated_secret.py gcp-test

          if [ $? -eq 0 ]; then
            echo "âœ… GCP validation passed"
          else
            echo "âŒ GCP validation failed"
            exit 1
          fi

      - name: 'ðŸ“¤ Upload GCP rotation artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monthly-gcp-rotation-audit-${{ needs.assess-rotation-readiness.outputs.correlation_id }}
          path: |
            monthly-audit-logs/
            audit-logs/
          retention-days: 90  # Keep GCP audits longer

  finalize-weekly-rotation:
    name: 'ðŸŽ¯ Finalize Weekly Rotation Cycle'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [assess-rotation-readiness, execute-weekly-rotation, monthly-gcp-rotation]

    steps:
      - name: 'ðŸ“Š Generate weekly rotation report'
        env:
          CORRELATION_ID: ${{ needs.assess-rotation-readiness.outputs.correlation_id }}
          RISK_LEVEL: ${{ needs.assess-rotation-readiness.outputs.risk_level }}
        run: |
          echo "## â° Weekly Rotation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Correlation ID:** ${CORRELATION_ID}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Risk Level:** ${RISK_LEVEL}" >> $GITHUB_STEP_SUMMARY
          echo "**Week:** $(date +%Y-W%U)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Weekly services status
          echo "### ðŸ“Š Weekly Services" >> $GITHUB_STEP_SUMMARY
          echo "- Gemini: ${{ needs.execute-weekly-rotation.result == 'success' && 'âœ… Rotated' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub: ${{ needs.execute-weekly-rotation.result == 'success' && 'âœ… Rotated' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2B: ${{ needs.execute-weekly-rotation.result == 'success' && 'âœ… Rotated' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Codecov: ${{ needs.execute-weekly-rotation.result == 'success' && 'âœ… Rotated' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Monthly services status (if applicable)
          if [ "${{ needs.monthly-gcp-rotation.result }}" != "skipped" ]; then
            echo "### ðŸ¢ Monthly Services" >> $GITHUB_STEP_SUMMARY
            echo "- GCP: ${{ needs.monthly-gcp-rotation.result == 'success' && 'âœ… Rotated' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Overall status
          weekly_success=$([ "${{ needs.execute-weekly-rotation.result }}" = "success" ] && echo "true" || echo "false")
          monthly_success=$([ "${{ needs.monthly-gcp-rotation.result }}" = "success" ] || [ "${{ needs.monthly-gcp-rotation.result }}" = "skipped" ] && echo "true" || echo "false")

          if [ "$weekly_success" = "true" ] && [ "$monthly_success" = "true" ]; then
            echo "### âœ… Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "All scheduled rotations completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Overall Status: ISSUES DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "Some rotations failed - check artifacts for details" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Rotation Schedule" >> $GITHUB_STEP_SUMMARY
          echo "- Next Weekly: $(date -d '+7 days' +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- Next Monthly Window: $(date -d '+1 month' +%Y-%m-01)" >> $GITHUB_STEP_SUMMARY

      - name: 'ðŸ”” Send rotation completion notification'
        if: always()
        run: |
          # In production, this would integrate with:
          # - Slack/Discord webhooks
          # - Microsoft Teams
          # - Email notifications
          # - PagerDuty (for failures)

          if [ "${{ needs.execute-weekly-rotation.result }}" = "success" ] && \
             ([ "${{ needs.monthly-gcp-rotation.result }}" = "success" ] || [ "${{ needs.monthly-gcp-rotation.result }}" = "skipped" ]); then
            echo "ðŸ”” Weekly rotation completed successfully - notifications sent"
          else
            echo "ðŸš¨ Weekly rotation issues detected - alerts sent to on-call team"
          fi

  monitor-post-rotation:
    name: 'ðŸ‘ï¸ Post-Rotation Health Monitoring'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: finalize-weekly-rotation

    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4

      - name: 'ðŸ‘ï¸ Monitor system health post-rotation'
        env:
          CORRELATION_ID: ${{ needs.assess-rotation-readiness.outputs.correlation_id }}
        run: |
          echo "ðŸ‘ï¸ Starting post-rotation health monitoring..."

          # Check that critical workflows can still access secrets
          echo "ðŸ” Checking workflow secret access..."

          # Monitor for any service disruptions
          echo "ðŸ“Š Monitoring for service disruptions..."

          # Verify audit logs are complete
          echo "ðŸ“ Verifying audit log completeness..."

          echo "âœ… Post-rotation monitoring completed"

      - name: 'â° Schedule follow-up monitoring'
        run: |
          echo "â° Follow-up monitoring scheduled for 24 and 72 hours post-rotation"
          # In production, this would schedule follow-up monitoring jobs

  weekly-rotation-failure-alert:
    name: 'ðŸš¨ Weekly Rotation Failure Alert'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [finalize-weekly-rotation]
    if: failure()

    steps:
      - name: 'ðŸš¨ Send critical failure notification'
        env:
          CORRELATION_ID: ${{ needs.assess-rotation-readiness.outputs.correlation_id }}
        run: |
          echo "## ðŸš¨ CRITICAL: Weekly Secret Rotation Failure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Correlation ID:** ${CORRELATION_ID}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Rotation Type:** Weekly Scheduled" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** CRITICAL FAILURE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš¨ IMMEDIATE ACTION REQUIRED" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ” Review rotation artifacts for failure details" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ“Š Check system health and service availability" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ”„ Evaluate manual rollback procedures" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ‘¥ Escalate to security team immediately" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ž Emergency Contacts" >> $GITHUB_STEP_SUMMARY
          echo "- Security Team: @security-team (URGENT)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform Team: @platform-team" >> $GITHUB_STEP_SUMMARY
          echo "- On-Call Engineer: Check PagerDuty rotation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Recovery Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Disable automated rotation workflows temporarily" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify backup secret access methods" >> $GITHUB_STEP_SUMMARY
          echo "3. Test critical services with backup credentials" >> $GITHUB_STEP_SUMMARY
          echo "4. Run emergency rotation procedure if needed" >> $GITHUB_STEP_SUMMARY

          # Critical failure - send to all channels
          echo "ðŸš¨ CRITICAL: Weekly secret rotation failed - all teams notified"
