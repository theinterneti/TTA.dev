name: '▶️ Gemini Invoke'

on:
  workflow_call:
    inputs:
      additional_context:
        type: 'string'
        description: 'Any additional context from the request'
        required: false
      issue_number:
        type: 'number'
        description: 'The issue or PR number to comment on'
        required: false
      is_pull_request:
        type: 'boolean'
        description: 'Whether this is a pull request'
        required: false
        default: false

concurrency:
  group: '${{ github.workflow }}-invoke-${{ github.event_name }}-${{ github.event.pull_request.number || github.event.issue.number }}'
  cancel-in-progress: false

defaults:
  run:
    shell: 'bash'

jobs:
  invoke:
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'write'
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: |-
          ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b' # ratchet:actions/create-github-app-token@v2
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          permission-contents: 'read'
          permission-issues: 'write'
          permission-pull-requests: 'write'

      - name: 'Install Gemini CLI'
        run: |
          npm install -g @google/gemini-cli@latest
          gemini --version

      - name: 'Run Gemini CLI with JSON output'
        id: 'run_gemini'
        env:
          GEMINI_API_KEY: '${{ secrets.GOOGLE_AI_STUDIO_API_KEY }}'
          PROMPT: '${{ inputs.additional_context }}'
        run: |
          # Run Gemini CLI with JSON output for reliable parsing
          echo "Executing Gemini CLI with prompt: ${PROMPT:0:100}..."

          # Run with --output-format json for structured output
          gemini --yolo \
            --model gemini-2.5-flash \
            --prompt "${PROMPT}" \
            --output-format json > gemini_output.json

          # Extract the response text from JSON
          RESPONSE=$(jq -r '.candidates[0].content.parts[0].text // .text // empty' gemini_output.json)

          # Debug output
          echo "Response length: ${#RESPONSE}"
          echo "Response preview: ${RESPONSE:0:200}"

          # Save to GitHub output using proper multiline format
          {
            echo "gemini_response<<EOF"
            echo "${RESPONSE}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

          # Also save full JSON for debugging
          echo "Full JSON output:"
          cat gemini_output.json

      - name: 'Post Gemini Response'
        if: always()  # Always run to debug, will check response inside script
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.mint_identity_token.outputs.token || github.token }}'
          script: |
            const response = `${{ steps.run_gemini.outputs.gemini_response }}`;
            const issueNumber = ${{ inputs.issue_number || 0 }};

            console.log('DEBUG: Response length:', response.length);
            console.log('DEBUG: Response preview:', response.substring(0, 100));
            console.log('DEBUG: Issue number:', issueNumber);

            if (!response || response.trim() === '') {
              console.log('No response from Gemini, skipping comment');
              return;
            }

            if (!issueNumber) {
              console.log('No issue number provided, skipping comment');
              return;
            }

            // Post to issue or PR
            console.log('Posting response to issue/PR #' + issueNumber);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `**Gemini Response:**\n\n${response}`
            });
