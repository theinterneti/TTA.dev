name: 'ğŸ”„ Automated Secret Rotation Orchestrator'

on:
  schedule:
    # Run monthly on the 1st at 2 AM PST
    - cron: '0 10 1 * *'
  workflow_dispatch:
    inputs:
      force_rotation:
        description: 'Force rotation even if not scheduled'
        required: false
        type: boolean
        default: false
      target_services:
        description: 'Comma-separated list of services to rotate (empty = all)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run mode - validate without actual rotation'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [secret-rotation-trigger]

concurrency:
  group: 'secret-rotation-${{ github.ref_name }}'
  cancel-in-progress: false

env:
  PYTHONUNBUFFERED: 1
  TZ: America/Los_Angeles

jobs:
  validate-rotation-environment:
    name: 'ğŸ” Validate Rotation Environment'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      should_rotate: ${{ steps.check-rotation.outputs.should_rotate }}
      rotation_schedule: ${{ steps.check-rotation.outputs.rotation_schedule }}
      target_services: ${{ steps.get-target-services.outputs.services }}
      correlation_id: ${{ steps.generate-id.outputs.correlation_id }}

    steps:
      - name: 'ğŸ“¥ Checkout repository'
        uses: actions/checkout@v4

      - name: 'ğŸ”¢ Generate correlation ID'
        id: generate-id
        run: |
          correlation_id=$(date +%Y%m%d-%H%M%S)-$(echo $RANDOM | md5sum | head -c 8)
          echo "correlation_id=${correlation_id}" >> $GITHUB_OUTPUT
          echo "ğŸ”¢ Correlation ID: ${correlation_id}"

      - name: 'ğŸ“… Check rotation schedule'
        id: check-rotation
        run: |
          echo "ğŸ” Checking rotation conditions..."

          # Get current date info
          current_day=$(date +%d)
          current_month=$(date +%m)
          current_year=$(date +%Y)
          current_day_of_week=$(date +%u) # 1=Monday, 7=Sunday

          # Default: Monthly rotation on the 1st
          should_rotate="false"
          schedule_type="monthly"

          # Check different schedules based on service sensitivity
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Scheduled rotation - always weekly for critical secrets
            should_rotate="true"
            schedule_type="weekly"
            echo "ğŸ“… Scheduled rotation triggered"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.force_rotation }}" = "true" ]; then
              should_rotate="true"
              schedule_type="forced"
              echo "ğŸ”§ Forced manual rotation triggered"
            else
              # Manual rotation - use monthly schedule
              should_rotate="true"
              schedule_type="manual"
              echo "ğŸ‘¤ Manual rotation requested"
            fi
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            should_rotate="true"
            schedule_type="api-triggered"
            echo "ğŸ”— API-triggered rotation"
          fi

          echo "should_rotate=${should_rotate}" >> $GITHUB_OUTPUT
          echo "rotation_schedule=${schedule_type}" >> $GITHUB_OUTPUT

      - name: 'ğŸ¯ Determine target services'
        id: get-target-services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.target_services }}" ]; then
            # Use specified services from manual trigger
            services="${{ inputs.target_services }}"
          else
            # Default service rotation (all high-risk secrets)
            services="gemini,github,e2b,gcp,codecov"
          fi

          echo "services=${services}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Target services: ${services}"

      - name: 'ğŸ“ Log rotation initiation'
        run: |
          echo "## ğŸ”„ Secret Rotation Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Correlation ID:** ${{ steps.generate-id.outputs.correlation_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Schedule:** ${{ steps.check-rotation.outputs.rotation_schedule }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Services:** ${{ steps.get-target-services.outputs.services }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  create-rotation-plan:
    name: 'ğŸ“‹ Create Rotation Plan'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate-rotation-environment
    if: needs.validate-rotation-environment.outputs.should_rotate == 'true'

    outputs:
      rotation_plan: ${{ steps.plan-rotation.outputs.plan }}

    steps:
      - name: 'ğŸ“¥ Checkout repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Python environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ğŸ“‹ Plan rotation strategy'
        id: plan-rotation
        env:
          CORRELATION_ID: ${{ needs.validate-rotation-environment.outputs.correlation_id }}
          TARGET_SERVICES: ${{ needs.validate-rotation-environment.outputs.target_services }}
          ROTATION_SCHEDULE: ${{ needs.validate-rotation-environment.outputs.rotation_schedule }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          echo "ğŸ“‹ Planning rotation strategy..."

          # Parse target services
          IFS=',' read -ra SERVICES <<< "$TARGET_SERVICES"

          # Create rotation plan JSON
          plan='{"correlation_id":"'$CORRELATION_ID'","schedule":"'$ROTATION_SCHEDULE'","dry_run":'$DRY_RUN',"services":['

          first=true
          for service in "${SERVICES[@]}"; do
            if [ "$first" = true ]; then
              first=false
            else
              plan+=','
            fi

            # Get service-specific rotation config
            case $service in
              gemini)
                plan+='{"name":"'$service'","priority":1,"grace_period_hours":24,"requires_validation":true}'
                ;;
              github)
                plan+='{"name":"'$service'","priority":2,"grace_period_hours":12,"requires_validation":true}'
                ;;
              e2b)
                plan+='{"name":"'$service'","priority":3,"grace_period_hours":6,"requires_validation":true}'
                ;;
              gcp)
                plan+='{"name":"'$service'","priority":4,"grace_period_hours":48,"requires_validation":true}'
                ;;
              codecov)
                plan+='{"name":"'$service'","priority":5,"grace_period_hours":12,"requires_validation":false}'
                ;;
              *)
                plan+='{"name":"'$service'","priority":10,"grace_period_hours":24,"requires_validation":true}'
                ;;
            esac
          done

          plan+='],"estimated_duration_minutes":'$((${#SERVICES[@]} * 10))'}'

          echo "plan=$plan" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Rotation plan created for ${#SERVICES[@]} services"

      - name: 'ğŸ“ Log rotation plan'
        run: |
          echo "## ğŸ“‹ Rotation Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.plan-rotation.outputs.plan }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  execute-secret-rotation:
    name: 'ğŸ”„ Execute Secret Rotation (${{ matrix.service }})'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [validate-rotation-environment, create-rotation-plan]

    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.create-rotation-plan.outputs.rotation_plan).services }}

    steps:
      - name: 'ğŸ“¥ Checkout repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Python environment'
        uses: ./.github/actions/setup-tta-env
        with:
          python-version: '3.12'

      - name: 'ğŸ”„ Execute rotation for ${{ matrix.service.name }}'
        id: rotate-secret
        env:
          CORRELATION_ID: ${{ needs.validate-rotation-environment.outputs.correlation_id }}
          SERVICE_NAME: ${{ matrix.service.name }}
          DRY_RUN: ${{ fromJSON(needs.create-rotation-plan.outputs.rotation_plan).dry_run }}
          ROTATION_PRIORITY: ${{ matrix.service.priority }}
          GRACE_PERIOD_HOURS: ${{ matrix.service.grace_period_hours }}
          REQUIRES_VALIDATION: ${{ matrix.service.requires_validation }}
          # Service-specific secrets for rotation
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_PERSONAL_ACCESS_TOKEN: ${{ secrets.GITHUB_PERSONAL_ACCESS_TOKEN }}
          E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
          GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          GOOGLE_CLOUD_LOCATION: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
          SERVICE_ACCOUNT_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          echo "ğŸ”„ Executing rotation for ${SERVICE_NAME}..."

          # Create audit log directory
          mkdir -p audit-logs

          # Execute rotation based on service
          case $SERVICE_NAME in
            gemini)
              python scripts/rotate_secrets.py gemini-rotate
              ;;
            github)
              python scripts/rotate_secrets.py github-rotate
              ;;
            e2b)
              python scripts/rotate_secrets.py e2b-rotate
              ;;
            gcp)
              python scripts/rotate_secrets.py gcp-rotate
              ;;
            codecov)
              python scripts/rotate_secrets.py codecov-rotate
              ;;
            *)
              echo "âŒ Unknown service: $SERVICE_NAME"
              exit 1
              ;;
          esac

          # Check rotation result
          if [ $? -eq 0 ]; then
            echo "rotation_success=true" >> $GITHUB_OUTPUT
            echo "âœ… ${SERVICE_NAME} rotation completed successfully"
          else
            echo "rotation_success=false" >> $GITHUB_OUTPUT
            echo "âŒ ${SERVICE_NAME} rotation failed"
            exit 1
          fi

      - name: 'ğŸ“¤ Upload rotation artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rotation-audit-${{ matrix.service.name }}-${{ needs.validate-rotation-environment.outputs.correlation_id }}
          path: audit-logs/
          retention-days: 90

      - name: 'ğŸ” Validate rotation'
        if: steps.rotate-secret.outputs.rotation_success == 'true' && matrix.service.requires_validation == true
        env:
          SERVICE_NAME: ${{ matrix.service.name }}
        run: |
          echo "ğŸ” Validating ${SERVICE_NAME} rotation..."

          case $SERVICE_NAME in
            gemini)
              python scripts/validate_rotated_secret.py gemini-test
              ;;
            github)
              python scripts/validate_rotated_secret.py github-test
              ;;
            e2b)
              python scripts/validate_rotated_secret.py e2b-test
              ;;
            gcp)
              python scripts/validate_rotated_secret.py gcp-test
              ;;
          esac

          if [ $? -eq 0 ]; then
            echo "âœ… ${SERVICE_NAME} validation passed"
          else
            echo "âŒ ${SERVICE_NAME} validation failed"
            exit 1
          fi

  finalize-rotation:
    name: 'ğŸ‰ Finalize Rotation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate-rotation-environment, execute-secret-rotation]

    steps:
      - name: 'ğŸ“¥ Checkout repository'
        uses: actions/checkout@v4

      - name: 'ğŸ“Š Generate rotation report'
        env:
          CORRELATION_ID: ${{ needs.validate-rotation-environment.outputs.correlation_id }}
          ROTATION_SCHEDULE: ${{ needs.validate-rotation-environment.outputs.rotation_schedule }}
        run: |
          echo "## ğŸ‰ Rotation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Correlation ID:** ${CORRELATION_ID}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Schedule:** ${ROTATION_SCHEDULE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ Success Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Rotation jobs completed: ${{ needs.execute-secret-rotation.result == 'success' && 'âœ… All' || 'âŒ Some failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Next Rotation Schedule" >> $GITHUB_STEP_SUMMARY
          echo "- Next monthly rotation: $(date -d '+1 month' +%Y-%m-01)" >> $GITHUB_STEP_SUMMARY
          echo "- Next weekly window: $(date -d '+1 week' +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY

      - name: 'ğŸ“¤ Create rotation complete notification'
        if: always()
        run: |
          # This would integrate with Slack/Discord webhooks
          # For now, log completion status
          if [ "${{ needs.execute-secret-rotation.result }}" = "success" ]; then
            echo "ğŸ‰ All secret rotations completed successfully"
          else
            echo "âš ï¸ Some rotations failed - check artifacts for details"
          fi

      - name: 'ğŸ§¹ Cleanup rotation artifacts (> 30 days old)'
        if: always()
        run: |
          # Cleanup old artifacts (would normally use GitHub API)
          echo "ğŸ§¹ Cleanup completed"

  rotation-failure-alert:
    name: 'ğŸš¨ Rotation Failure Alert'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [finalize-rotation]
    if: failure()

    steps:
      - name: 'ğŸš¨ Send failure notification'
        run: |
          echo "## ğŸš¨ SECRET ROTATION FAILURE ALERT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Correlation ID:** ${{ needs.validate-rotation-environment.outputs.correlation_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš¨ IMMEDIATE ACTION REQUIRED" >> $GITHUB_STEP_SUMMARY
          echo "1. Check rotation artifacts for failure details" >> $GITHUB_STEP_SUMMARY
          echo "2. Review audit logs in artifact storage" >> $GITHUB_STEP_SUMMARY
          echo "3. Manually validate affected secrets" >> $GITHUB_STEP_SUMMARY
          echo "4. Rollback any partially rotated secrets if needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Escalation Contacts" >> $GITHUB_STEP_SUMMARY
          echo "- Security Team: @security-team" >> $GITHUB_STEP_SUMMARY
          echo "- Platform Team: @platform-team" >> $GITHUB_STEP_SUMMARY

          # In a production setup, this would send alerts to:
          # - Slack/Discord channels
          # - PagerDuty/on-call systems
          # - Security information and event management (SIEM) systems
