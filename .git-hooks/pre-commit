#!/bin/bash
# TTA.dev Multi-Agent Pre-Commit Hook
# This hook runs before commits from any agent worktree

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ü§ñ TTA.dev Multi-Agent Pre-Commit Hook${NC}"

# Identify which agent is committing
WORKTREE_PATH=$(git rev-parse --show-toplevel)
BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [[ "$WORKTREE_PATH" == *"TTA.dev-augment"* ]]; then
    AGENT="augment"
elif [[ "$WORKTREE_PATH" == *"TTA.dev-cline"* ]]; then
    AGENT="cline"
elif [[ "$WORKTREE_PATH" == *"TTA.dev-copilot"* ]]; then
    AGENT="copilot"
else
    AGENT="unknown"
fi

echo -e "Agent: ${GREEN}$AGENT${NC}"
echo -e "Branch: ${GREEN}$BRANCH${NC}"
echo -e "Worktree: ${GREEN}$WORKTREE_PATH${NC}"

# Check if this is an agent branch
if [[ "$BRANCH" == agent/* ]]; then
    echo -e "${YELLOW}üìã Agent branch detected - running validation...${NC}"
    
    # 1. Check for secrets
    if command -v detect-secrets &> /dev/null; then
        echo -e "${YELLOW}üîê Scanning for secrets...${NC}"
        detect-secrets scan --baseline .secrets.baseline
    fi
    
    # 2. Check Python syntax if files changed
    PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)
    if [ -n "$PYTHON_FILES" ]; then
        echo -e "${YELLOW}üêç Validating Python syntax...${NC}"
        for file in $PYTHON_FILES; do
            if [ -f "$file" ]; then
                python3 -m py_compile "$file" || {
                    echo -e "${RED}‚ùå Syntax error in $file${NC}"
                    exit 1
                }
            fi
        done
    fi
    
    # 3. Check commit message format
    COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
    if [ -f "$COMMIT_MSG_FILE" ]; then
        COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
        
        # Ensure agent is identified in commit
        if ! echo "$COMMIT_MSG" | grep -qE "\[agent:(augment|cline|copilot)\]"; then
            echo -e "${YELLOW}‚ö†Ô∏è  Adding agent identifier to commit message${NC}"
            # This will be added by prepare-commit-msg hook
        fi
    fi
    
    echo -e "${GREEN}‚úÖ Pre-commit validation passed${NC}"
else
    echo -e "${YELLOW}‚ÑπÔ∏è  Non-agent branch - skipping agent-specific checks${NC}"
fi

exit 0
