#!/bin/bash

# TTA.dev Agent Workspace Setup
# Complete automated setup for all agent contexts with role-specific guidance

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Script configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
SETUP_DIR="${SCRIPT_DIR}/setup"

# Default configuration
FORCE_SETUP=false
SPECIFIED_CONTEXT=""

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE_SETUP=true
            shift
            ;;
        --context)
            SPECIFIED_CONTEXT="$2"
            shift 2
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

show_help() {
    cat << EOF
TTA.dev Agent Workspace Setup

USAGE:
    $0 [OPTIONS]

OPTIONS:
    --force             Force setup even if already configured
    --context CONTEXT   Specify agent context manually
    --help, -h          Show this help message

CONTEXTS:
    vscode-local        VS Code Extension (local development)
    github-actions      GitHub Actions Coding Agent (ephemeral)
    cline-local         Cline Extension (local development)
    github-cli          GitHub CLI (terminal)

EXAMPLES:
    $0                                  # Auto-detect context and setup
    $0 --force                          # Force complete re-setup
    $0 --context vscode-local           # Setup for VS Code specifically
    $0 --context github-actions         # Setup for GitHub Actions environment

EOF
}

# Context detection functions
detect_agent_context() {
    local context=""

    # Check for GitHub Actions environment
    if [[ -n "${GITHUB_ACTIONS:-}" ]]; then
        context="github-actions"

    # Check for VS Code environment
    elif [[ -n "${VSCODE_PID:-}" ]] || [[ -n "${TERM_PROGRAM:-}" && "${TERM_PROGRAM}" == "vscode" ]]; then
        context="vscode-local"

    # Check for Cline-specific indicators
    elif [[ -f "${PROJECT_ROOT}/.cline/instructions.md" ]] && [[ -n "${VSCODE_PID:-}" ]]; then
        context="cline-local"

    # Check for terminal with GitHub CLI
    elif command -v gh >/dev/null 2>&1; then
        context="github-cli"

    # Default to VS Code if uncertain
    else
        context="vscode-local"
    fi

    echo "$context"
}# Common setup functions
setup_uv() {
    log_info "Setting up uv package manager..."

    if ! command -v uv >/dev/null 2>&1; then
        log_warning "uv not found, installing..."
        curl -LsSf https://astral.sh/uv/install.sh | sh
        export PATH="$HOME/.cargo/bin:$PATH"
    fi

    log_success "uv is available: $(uv --version)"
}

setup_python_environment() {
    log_info "Setting up Python environment..."

    cd "$PROJECT_ROOT"

    # Sync dependencies
    log_info "Syncing Python dependencies..."
    uv sync --all-extras

    # Verify core imports
    log_info "Verifying core imports..."
    if uv run python -c "import tta_dev_primitives; print('‚úÖ tta-dev-primitives loaded successfully')" 2>/dev/null; then
        log_success "Core imports verified"
    else
        log_error "Core imports failed - dependency issue detected"
        return 1
    fi
}

setup_git_hooks() {
    log_info "Setting up Git hooks..."

    local hooks_dir="${PROJECT_ROOT}/.git/hooks"
    local post_commit_hook="${hooks_dir}/post-commit"

    # Create post-commit hook for activity tracking
    if [[ ! -f "$post_commit_hook" ]]; then
        cat > "$post_commit_hook" << 'EOF'
#!/bin/bash
# TTA.dev activity tracker hook
if command -v systemctl >/dev/null 2>&1; then
    systemctl --user restart tta-activity-tracker.service 2>/dev/null || true
fi
EOF
        chmod +x "$post_commit_hook"
        log_success "Git post-commit hook installed"
    fi
}

validate_setup() {
    log_info "Validating setup..."

    local validation_errors=0

    # Check Python environment
    if ! uv run python -c "import tta_dev_primitives" 2>/dev/null; then
        log_error "Python environment validation failed"
        ((validation_errors++))
    fi

    # Check Git repository
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        log_error "Not in a Git repository"
        ((validation_errors++))
    fi

    # Check project structure
    local required_dirs=("packages" "scripts" "docs" "logseq")
    for dir in "${required_dirs[@]}"; do
        if [[ ! -d "${PROJECT_ROOT}/${dir}" ]]; then
            log_error "Missing required directory: $dir"
            ((validation_errors++))
        fi
    done

    if [[ $validation_errors -eq 0 ]]; then
        log_success "Setup validation passed"
        return 0
    else
        log_error "Setup validation failed with $validation_errors errors"
        return 1
    fi
}

# Context-specific setup orchestration
setup_context() {
    local context="$1"
    local setup_script="${SETUP_DIR}/${context//-/_}-agent.sh"

    # Map context names to script names
    case "$context" in
        "vscode-local")
            setup_script="${SETUP_DIR}/vscode-agent.sh"
            ;;
        "github-actions")
            setup_script="${SETUP_DIR}/github-actions-agent.sh"
            ;;
        "cline-local")
            setup_script="${SETUP_DIR}/cline-agent.sh"
            ;;
        "github-cli")
            log_info "GitHub CLI context detected - manual setup required"
            show_cli_setup_instructions
            return 0
            ;;
        *)
            log_error "Unknown context: $context"
            return 1
            ;;
    esac

    if [[ -f "$setup_script" ]]; then
        log_info "Running context-specific setup: $context"
        bash "$setup_script" ${FORCE_SETUP:+--force}
    else
        log_error "Setup script not found: $setup_script"
        return 1
    fi
}

show_cli_setup_instructions() {
    cat << EOF

üìã GitHub CLI Setup Instructions:

1. Install GitHub CLI:
   curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
   echo "deb [arch=\$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
   sudo apt update && sudo apt install gh

2. Authenticate:
   gh auth login

3. Configure for TTA.dev:
   gh repo clone theinterneti/TTA.dev
   cd TTA.dev

4. Use standard CLI commands:
   gh copilot suggest "How to run tests"
   gh copilot explain "git log --oneline"

EOF
}

show_role_selection_guide() {
    cat << EOF

üéØ Agent Role Selection Guide:

Choose your role based on experience and focus:

üìù Documentation Writer (Beginner)
   ‚Ä¢ Best for: New to TTA.dev, documentation focus
   ‚Ä¢ Toolsets: #tta-docs, #tta-minimal
   ‚Ä¢ Start with: README updates, basic guides

üîß Package Developer (Intermediate)
   ‚Ä¢ Best for: Python experience, feature development
   ‚Ä¢ Toolsets: #tta-package-dev, #tta-testing
   ‚Ä¢ Start with: Simple primitive modifications

üìä Observability Engineer (Advanced)
   ‚Ä¢ Best for: Production systems experience
   ‚Ä¢ Toolsets: #tta-observability, #tta-troubleshoot
   ‚Ä¢ Start with: Basic metrics implementation

üß† Agent Coordinator (Expert)
   ‚Ä¢ Best for: Multi-agent workflow expertise
   ‚Ä¢ Toolsets: #tta-agent-dev, #tta-mcp-integration
   ‚Ä¢ Start with: Basic agent coordination

EOF
}

show_next_steps() {
    local context="$1"

    cat << EOF

üöÄ Setup Complete! Next Steps:

EOF

    case "$context" in
        "vscode-local")
            cat << EOF
VS Code Extension Setup:
1. Reload VS Code window: Ctrl+Shift+P ‚Üí "Developer: Reload Window"
2. Choose your role and test setup:
   @workspace #tta-docs
   Help me understand TTA.dev architecture and suggest next steps

3. Available toolsets:
   ‚Ä¢ #tta-docs - Documentation work
   ‚Ä¢ #tta-package-dev - Core development
   ‚Ä¢ #tta-observability - Tracing & metrics
   ‚Ä¢ #tta-agent-dev - Multi-agent workflows

EOF
            ;;
        "github-actions")
            cat << EOF
GitHub Actions Environment:
1. Test environment:
   uv run pytest -v

2. Remember limitations:
   ‚ùå No MCP servers
   ‚ùå No Copilot toolsets
   ‚úÖ Standard development tools

3. Use direct commands:
   uv run pytest --cov=packages
   uv run ruff check . --fix

EOF
            ;;
        "cline-local")
            cat << EOF
Cline Extension Setup:
1. Enhanced MCP integration ready
2. Use Cline's chat interface with full MCP capabilities
3. Collaborative features enabled

EOF
            ;;
    esac

    cat << EOF
üìö Documentation:
   ‚Ä¢ Agent Instructions: .github/copilot-instructions.md
   ‚Ä¢ TODO Management: logseq/pages/TODO Management System.md
   ‚Ä¢ Setup Troubleshooting: scripts/setup-agent-workspace.sh --help

EOF
}

# Main execution flow
main() {
    log_info "TTA.dev Agent Workspace Setup Starting..."

    # Create setup directory if it doesn't exist
    mkdir -p "$SETUP_DIR"

    # Determine context
    local context=""
    if [[ -n "$SPECIFIED_CONTEXT" ]]; then
        context="$SPECIFIED_CONTEXT"
        log_info "Using specified context: $context"
    else
        context=$(detect_agent_context)
    fi

    log_info "Detected context: $context"

    # Common setup steps
    log_info "Running common setup steps..."
    setup_uv || { log_error "uv setup failed"; exit 1; }
    setup_python_environment || { log_error "Python environment setup failed"; exit 1; }
    setup_git_hooks || { log_warning "Git hooks setup failed"; }

    # Context-specific setup
    log_info "Setting up context: $context"
    setup_context "$context" || { log_error "Context-specific setup failed"; exit 1; }

    # Final validation
    validate_setup || { log_error "Setup validation failed"; exit 1; }

    # Show completion message
    log_success "TTA.dev Agent Workspace Setup Complete!"
    show_role_selection_guide
    show_next_steps "$context"
}

# Run main function
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi

### User Skill Levels

| Level | Experience | Agent Guidance | Toolset Recommendations |
|-------|------------|----------------|------------------------|
| **New User** | First time with TTA.dev | Step-by-step guides, examples | `#tta-minimal`, `#tta-docs` |
| **Intermediate** | Some AI/agent experience | Best practices, patterns | `#tta-package-dev`, `#tta-testing` |
| **Advanced** | Production AI applications | Architecture guidance, optimization | `#tta-observability`, `#tta-agent-dev` |
| **Expert** | AI platform development | Deep integration, custom primitives | `#tta-full-stack`, custom toolsets |

---

## üöÄ Automatic Workspace Setup

### Quick Setup Script

Create one-command setup for any agent context:

```bash
# Run automatic setup based on detected context
curl -sSL https://raw.githubusercontent.com/theinterneti/TTA.dev/main/scripts/setup-agent-workspace.sh | bash
```

### Context Detection Logic

The setup script automatically detects:

```bash
#!/bin/bash
# scripts/setup-agent-workspace.sh

# Detect agent context
detect_agent_context() {
    if [ -n "$GITHUB_ACTIONS" ]; then
        echo "coding-agent"
    elif [ -n "$CODESPACES" ]; then
        echo "github-codespaces"
    elif command -v code >/dev/null 2>&1; then
        echo "vscode-local"
    elif [ -n "$WSL_DISTRO_NAME" ]; then
        echo "wsl-local"
    else
        echo "terminal-local"
    fi
}

# Setup based on detected context
CONTEXT=$(detect_agent_context)
echo "Detected agent context: $CONTEXT"

case $CONTEXT in
    "coding-agent")
        ./scripts/setup/github-actions-agent.sh
        ;;
    "vscode-local")
        ./scripts/setup/vscode-agent.sh
        ;;
    "wsl-local")
        ./scripts/setup/wsl-agent.sh
        ;;
    *)
        ./scripts/setup/generic-agent.sh
        ;;
esac
```

---

## üìã VS Code Agent Instructions

### Context: Local Development with Full Features

**Available Tools:**
- ‚úÖ MCP servers (Context7, AI Toolkit, Grafana, etc.)
- ‚úÖ Copilot toolsets (`#tta-package-dev`, `#tta-observability`, etc.)
- ‚úÖ Local filesystem access
- ‚úÖ Docker containers and services
- ‚úÖ Python environment management

### Setup Requirements

**Automatic Setup:**
```bash
# Run VS Code agent setup
./scripts/setup/vscode-agent.sh
```

**Manual Verification:**
1. **Python Environment:** `uv --version` should show uv package manager
2. **Dependencies:** `uv sync --all-extras` should complete successfully
3. **Observability:** Run `./scripts/verify-and-setup-persistence.sh`
4. **MCP Servers:** Check MCP server status in VS Code
5. **Docker Services:** `docker-compose -f docker-compose.integration.yml ps`

### Recommended Workflow

**For Package Development:**
```markdown
@workspace #tta-package-dev

I want to add a new primitive to tta-dev-primitives. Please:
1. Check the existing primitive patterns
2. Create the new primitive with full type safety
3. Add comprehensive tests with 100% coverage
4. Create examples showing usage
5. Update documentation
```

**For Observability Work:**
```markdown
@workspace #tta-observability

I need to add new metrics to the CachePrimitive. Please:
1. Check current Prometheus metrics setup
2. Add the new metrics following conventions
3. Update Grafana dashboards
4. Test with docker-compose integration stack
```

### Context Awareness

**You are the VS Code Extension** when:
- You have access to MCP tools (mcp_context7_*, aitk_*, etc.)
- Copilot toolsets work (`#tta-package-dev`)
- You can read/write local files
- Docker commands execute successfully

**Key Capabilities:**
- Use MCP servers for documentation lookup
- Leverage toolsets for focused workflows
- Access full observability stack
- Integrate with Cline for collaboration

---

## ‚òÅÔ∏è Coding Agent Instructions

### Context: GitHub Actions Environment (Ephemeral)

**Available Tools:**
- ‚úÖ GitHub Actions tools and APIs
- ‚úÖ Installed packages (uv, pytest, ruff, etc.)
- ‚úÖ Terminal commands and file operations
- ‚ùå NO MCP servers (VS Code only feature)
- ‚ùå NO Copilot toolsets (VS Code only feature)
- ‚ùå NO persistent state (ephemeral environment)

### Environment Details

**Your Runtime:**
- Ubuntu latest runner (2 CPU, 7GB RAM, 14GB disk)
- Python 3.11 + uv package manager
- All dependencies pre-installed via `uv sync --all-extras`
- Setup time: ~9-11 seconds (with cache)
- Session timeout: 60 minutes maximum

**Environment Variables:**
```bash
PYTHONPATH=$PWD/packages
PYTHONUTF8=1
PYTHONDONTWRITEBYTECODE=1
UV_CACHE_DIR=~/.cache/uv
```

### Setup Verification

**Check Your Environment:**
```bash
# Run environment verification
./scripts/check-environment.sh

# Manual checks
uv --version
python --version
uv run pytest --version
docker --version  # May not be available
```

### Recommended Workflow

**For Implementation Tasks:**
```bash
# 1. Understand the codebase
find packages/ -name "*.py" -path "*/src/*" | head -20

# 2. Run tests to understand current state
uv run pytest -v

# 3. Make your changes using available tools
# - read_file, replace_string_in_file
# - run_in_terminal for uv/pytest commands
# - create_file for new components

# 4. Validate changes
uv run pytest -v
uv run ruff check . --fix
uvx pyright packages/
```

### Context Awareness

**You are the Coding Agent** when:
- Environment variable `GITHUB_ACTIONS=true`
- No MCP tools available (tool calls will fail)
- Working in `/home/runner/work/TTA.dev/TTA.dev`
- Have access to `uv`, `pytest`, `ruff`, `pyright`

**Key Limitations:**
- Cannot use `@workspace #toolset-name` syntax
- No MCP server documentation lookup
- No VS Code extension features
- Ephemeral environment (no persistent state)

**Best Practices:**
- Use `uv run` for all Python commands
- Run tests frequently to validate changes
- Focus on core functionality without VS Code integrations
- Document decisions in commit messages

---

## üñ•Ô∏è Cline Agent Instructions

### Context: Local Development with Enhanced MCP Integration

**Cline** is a VS Code extension that natively supports MCP servers and can collaborate with GitHub Copilot using shared infrastructure.

**Available Tools:**
- ‚úÖ All MCP servers (same as VS Code Copilot)
- ‚úÖ Native MCP integration (better than Copilot)
- ‚úÖ VS Code integration and file operations
- ‚úÖ Terminal access and command execution
- ‚úÖ Collaboration with GitHub Copilot

### Setup Requirements

**MCP Configuration:**
Cline uses the same MCP configuration as VS Code Copilot:
```bash
# MCP servers configured in VS Code settings
# Cline automatically detects and uses them
```

**Recommended Configuration:**
```json
// VS Code settings.json (shared with Cline)
{
  "cline.mcp.enabled": true,
  "cline.mcp.servers": {
    "context7": "auto-detect",
    "ai-toolkit": "auto-detect",
    "grafana": "auto-detect"
  }
}
```

### Collaboration Patterns

**Cline + Copilot Workflow:**
1. **Cline** - Complex implementation tasks with MCP research
2. **Copilot** - Quick edits and code generation with toolsets
3. **Shared MCP** - Both agents use same documentation sources

**Example Collaboration:**
```markdown
# Cline: Research and plan
Use MCP to research the latest patterns for RetryPrimitive implementation

# Copilot: Implement with toolset
@workspace #tta-package-dev
Based on Cline's research, implement the RetryPrimitive with exponential backoff
```

### Context Awareness

**You are using Cline** when:
- Native MCP server integration works seamlessly
- Can perform complex multi-step research tasks
- Have enhanced code understanding capabilities
- Working collaboratively with other AI agents

---

## üíª CLI Agent Instructions

### Context: Terminal Environment via GitHub CLI

**Available Tools:**
- ‚úÖ GitHub API access
- ‚úÖ Terminal environment
- ‚úÖ Local filesystem
- ‚ùå NO MCP servers
- ‚ùå NO VS Code features

### Setup Requirements

**GitHub CLI Setup:**
```bash
# Install GitHub CLI
curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg

# Authenticate
gh auth login
```

### Recommended Usage

**Repository Operations:**
```bash
# Clone and setup
gh repo clone theinterneti/TTA.dev
cd TTA.dev
./scripts/setup-agent-workspace.sh

# Create PRs and issues
gh pr create --title "Add new primitive" --body "Description"
gh issue create --title "Bug report" --body "Details"
```

**Context Awareness:**
- Terminal-focused operations
- GitHub API integration
- No advanced IDE features

---

## üõ†Ô∏è Workspace Setup Scripts

### Master Setup Script

<function_calls>
<invoke name="create_file">
<parameter name="content">#!/bin/bash
# scripts/setup-agent-workspace.sh
# Automatic workspace setup for any agent context

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() { echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"; }
log_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
log_warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }
log_error() { echo -e "${RED}‚ùå $1${NC}"; }

# Detect agent context
detect_agent_context() {
    if [ -n "${GITHUB_ACTIONS:-}" ]; then
        echo "coding-agent"
    elif [ -n "${CODESPACES:-}" ]; then
        echo "github-codespaces"
    elif [ -n "${WSL_DISTRO_NAME:-}" ]; then
        echo "wsl-local"
    elif command -v code >/dev/null 2>&1 && [ -n "${VSCODE_PID:-}" ]; then
        echo "vscode-local"
    elif [ -n "${TERM_PROGRAM:-}" ] && [ "$TERM_PROGRAM" = "vscode" ]; then
        echo "vscode-integrated-terminal"
    else
        echo "terminal-local"
    fi
}

# Check if we're in TTA.dev repository
check_repository() {
    if [ ! -f "pyproject.toml" ] || ! grep -q "name = \"tta-dev-primitives\"" pyproject.toml 2>/dev/null; then
        log_error "Not in TTA.dev repository root. Please navigate to TTA.dev directory first."
        exit 1
    fi
    log_success "Confirmed TTA.dev repository"
}

# Check and install uv package manager
setup_uv() {
    log_info "Setting up uv package manager..."

    if ! command -v uv >/dev/null 2>&1; then
        log_info "Installing uv package manager..."
        curl -LsSf https://astral.sh/uv/install.sh | sh
        export PATH="$HOME/.cargo/bin:$PATH"
        source ~/.bashrc 2>/dev/null || true
    fi

    if command -v uv >/dev/null 2>&1; then
        log_success "uv package manager available: $(uv --version)"
    else
        log_error "Failed to install uv package manager"
        exit 1
    fi
}

# Setup Python environment and dependencies
setup_python_environment() {
    log_info "Setting up Python environment..."

    # Sync all dependencies
    log_info "Syncing dependencies with uv..."
    uv sync --all-extras

    # Verify Python setup
    if uv run python --version >/dev/null 2>&1; then
        PYTHON_VERSION=$(uv run python --version)
        log_success "Python environment ready: $PYTHON_VERSION"
    else
        log_error "Python environment setup failed"
        exit 1
    fi
}

# Setup observability infrastructure (local contexts only)
setup_observability() {
    local context=$1

    if [[ "$context" == "coding-agent" ]]; then
        log_info "Skipping observability setup in GitHub Actions environment"
        return 0
    fi

    log_info "Setting up observability infrastructure..."

    if [ -f "./scripts/verify-and-setup-persistence.sh" ]; then
        ./scripts/verify-and-setup-persistence.sh
        log_success "Observability infrastructure verified"
    else
        log_warning "Observability setup script not found, skipping"
    fi
}

# Validate workspace setup
validate_setup() {
    local context=$1
    log_info "Validating workspace setup..."

    # Test basic functionality
    local validation_errors=0

    # Check uv
    if ! command -v uv >/dev/null 2>&1; then
        log_error "uv package manager not available"
        ((validation_errors++))
    fi

    # Check Python environment
    if ! uv run python -c "import sys; print(f'Python {sys.version}')" >/dev/null 2>&1; then
        log_error "Python environment not working"
        ((validation_errors++))
    fi

    # Check dependencies
    if ! uv run python -c "import tta_dev_primitives; print('‚úÖ tta-dev-primitives imported')" 2>/dev/null; then
        log_error "Core dependencies not available"
        ((validation_errors++))
    fi

    # Check testing
    if ! uv run pytest --version >/dev/null 2>&1; then
        log_error "pytest not available"
        ((validation_errors++))
    fi

    # Context-specific validation
    if [[ "$context" == "vscode-local" ]] || [[ "$context" == "vscode-integrated-terminal" ]]; then
        # Check VS Code extensions
        if command -v code >/dev/null 2>&1; then
            if ! code --list-extensions | grep -q "github.copilot"; then
                log_warning "GitHub Copilot extension not installed"
            fi
        fi

        # Check MCP server accessibility (best effort)
        if [ -f ".vscode/settings.json" ]; then
            log_success "VS Code configuration found"
        fi
    fi

    if [ $validation_errors -eq 0 ]; then
        log_success "Workspace validation completed successfully"
        return 0
    else
        log_error "Workspace validation found $validation_errors error(s)"
        return 1
    fi
}

# Display setup summary and next steps
show_next_steps() {
    local context=$1

    echo
    log_success "üéâ TTA.dev Agent Workspace Setup Complete!"
    echo
    log_info "Agent Context: $context"
    log_info "Python: $(uv run python --version 2>/dev/null || echo 'Not available')"
    log_info "uv: $(uv --version 2>/dev/null || echo 'Not available')"
    echo

    case $context in
        "vscode-local"|"vscode-integrated-terminal")
            echo -e "${BLUE}üìã Next Steps for VS Code Development:${NC}"
            echo "  1. Use Copilot toolsets: @workspace #tta-package-dev"
            echo "  2. Check MCP servers in VS Code"
            echo "  3. Run tests: uv run pytest -v"
            echo "  4. Access observability: http://localhost:3000 (Grafana)"
            ;;
        "coding-agent")
            echo -e "${BLUE}üìã Next Steps for GitHub Actions:${NC}"
            echo "  1. Run tests: uv run pytest -v"
            echo "  2. Check code quality: uv run ruff check ."
            echo "  3. Type checking: uvx pyright packages/"
            echo "  4. Use terminal tools (no MCP/toolsets available)"
            ;;
        "wsl-local"|"terminal-local")
            echo -e "${BLUE}üìã Next Steps for Local Development:${NC}"
            echo "  1. Consider using VS Code for full features"
            echo "  2. Run tests: uv run pytest -v"
            echo "  3. Check GitHub CLI: gh --version"
            echo "  4. Access observability: http://localhost:3000"
            ;;
    esac

    echo
    echo -e "${BLUE}üìö Documentation:${NC}"
    echo "  ‚Ä¢ Agent Instructions: AGENTS.md"
    echo "  ‚Ä¢ Getting Started: GETTING_STARTED.md"
    echo "  ‚Ä¢ Primitives Catalog: PRIMITIVES_CATALOG.md"
    echo "  ‚Ä¢ Toolsets Guide: .vscode/README.md"
    echo
}

# Main execution
main() {
    local context
    local force_setup=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --force)
                force_setup=true
                shift
                ;;
            --context)
                context="$2"
                shift 2
                ;;
            -h|--help)
                echo "Usage: $0 [--force] [--context CONTEXT]"
                echo "       $0 --help"
                echo
                echo "Automatically setup TTA.dev workspace for agent development"
                echo
                echo "Options:"
                echo "  --force     Force setup even if already configured"
                echo "  --context   Override context detection (coding-agent, vscode-local, etc.)"
                echo "  --help      Show this help message"
                exit 0
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    # Detect context if not provided
    if [ -z "${context:-}" ]; then
        context=$(detect_agent_context)
    fi

    log_info "üöÄ TTA.dev Agent Workspace Setup"
    log_info "Detected context: $context"
    echo

    # Check repository
    check_repository

    # Setup steps
    setup_uv
    setup_python_environment
    setup_observability "$context"

    # Validate everything works
    if validate_setup "$context"; then
        show_next_steps "$context"
        exit 0
    else
        log_error "Setup validation failed. Please check the errors above."
        exit 1
    fi
}

# Run main function with all arguments
main "$@"
