name: 'Test Gemini API Keys'

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message to send to Gemini'
        required: false
        default: 'Say hello in one sentence'

jobs:
  test-keys:
    name: 'Test API Keys'
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
    
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'
      
      - name: 'Test AI Studio Key'
        id: 'test_ai_studio'
        env:
          API_KEY: '${{ secrets.GOOGLE_AI_STUDIO_API_KEY }}'
          TEST_MESSAGE: '${{ inputs.test_message }}'
        run: |
          echo "::group::Testing AI Studio API Key"
          echo "Model: gemini-1.5-flash"
          echo "Endpoint: generativelanguage.googleapis.com"
          echo ""
          
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{\"text\": \"${TEST_MESSAGE}\"}]
              }]
            }" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}")
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Status: $http_code"
          echo ""
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… SUCCESS! AI Studio API key works"
            echo ""
            echo "Response:"
            echo "$body" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null || echo "$body" | jq '.'
            echo "ai_studio_works=true" >> $GITHUB_OUTPUT
            echo "ai_studio_response<<EOF" >> $GITHUB_OUTPUT
            echo "$body" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âŒ FAILED! AI Studio API key does not work"
            echo ""
            echo "Error response:"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
            echo "ai_studio_works=false" >> $GITHUB_OUTPUT
            echo "ai_studio_error<<EOF" >> $GITHUB_OUTPUT
            echo "$body" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"
      
      - name: 'Test Vertex AI Key (Alternative Method)'
        id: 'test_vertex'
        continue-on-error: true
        env:
          API_KEY: '${{ secrets.VERTEX_API_KEY }}'
          PROJECT_ID: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          LOCATION: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          TEST_MESSAGE: '${{ inputs.test_message }}'
        run: |
          echo "::group::Testing Vertex AI Key"
          echo "Project: ${PROJECT_ID:-604126426981}"
          echo "Location: ${LOCATION:-us-central1}"
          echo "Model: gemini-1.5-flash"
          echo ""
          
          PROJECT="${PROJECT_ID:-604126426981}"
          LOC="${LOCATION:-us-central1}"
          
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${API_KEY}" \
            -d "{
              \"contents\": [{
                \"role\": \"user\",
                \"parts\": [{\"text\": \"${TEST_MESSAGE}\"}]
              }]
            }" \
            "https://${LOC}-aiplatform.googleapis.com/v1/projects/${PROJECT}/locations/${LOC}/publishers/google/models/gemini-1.5-flash:generateContent")
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Status: $http_code"
          echo ""
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… SUCCESS! Vertex AI key works"
            echo ""
            echo "Response:"
            echo "$body" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null || echo "$body" | jq '.'
            echo "vertex_works=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Vertex AI key test inconclusive (may need service account)"
            echo ""
            echo "Response:"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
            echo "vertex_works=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"
      
      - name: 'Test Legacy GEMINI_API_KEY'
        id: 'test_legacy'
        env:
          API_KEY: '${{ secrets.GEMINI_API_KEY }}'
          TEST_MESSAGE: '${{ inputs.test_message }}'
        run: |
          echo "::group::Testing Legacy GEMINI_API_KEY"
          echo "Model: gemini-1.5-flash"
          echo "Endpoint: generativelanguage.googleapis.com"
          echo ""
          
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{\"text\": \"${TEST_MESSAGE}\"}]
              }]
            }" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}")
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Status: $http_code"
          echo ""
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… SUCCESS! Legacy GEMINI_API_KEY works"
            echo ""
            echo "Response:"
            echo "$body" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null || echo "$body" | jq '.'
            echo "legacy_works=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ FAILED! Legacy GEMINI_API_KEY does not work"
            echo ""
            echo "Error response:"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
            echo "legacy_works=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"
      
      - name: 'Summary Report'
        run: |
          echo "## ðŸ§ª API Key Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test_ai_studio.outputs.ai_studio_works }}" = "true" ]; then
            echo "### âœ… AI Studio Key (GOOGLE_AI_STUDIO_API_KEY)" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: Working" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Response**: ${{ steps.test_ai_studio.outputs.ai_studio_response }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommendation**: Use this key for gemini-cli workflows" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ AI Studio Key (GOOGLE_AI_STUDIO_API_KEY)" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error**: See logs above" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test_legacy.outputs.legacy_works }}" = "true" ]; then
            echo "### âœ… Legacy Key (GEMINI_API_KEY)" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: Working" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note**: This key also works as a fallback" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Legacy Key (GEMINI_API_KEY)" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine next steps
          if [ "${{ steps.test_ai_studio.outputs.ai_studio_works }}" = "true" ]; then
            echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… API keys work correctly" >> $GITHUB_STEP_SUMMARY
            echo "2. âš ï¸ Issue is with gemini-cli GitHub Action" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ”§ Options:" >> $GITHUB_STEP_SUMMARY
            echo "   - Implement direct API calls in workflow" >> $GITHUB_STEP_SUMMARY
            echo "   - File bug report with gemini-cli maintainers" >> $GITHUB_STEP_SUMMARY
            echo "   - Try alternative Gemini GitHub Actions" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ”§ Troubleshooting Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "API keys failed direct testing. Check:" >> $GITHUB_STEP_SUMMARY
            echo "1. API key permissions in Google Cloud Console" >> $GITHUB_STEP_SUMMARY
            echo "2. Generative Language API is enabled" >> $GITHUB_STEP_SUMMARY
            echo "3. API key restrictions (IP, HTTP referrer)" >> $GITHUB_STEP_SUMMARY
            echo "4. Billing status (if required)" >> $GITHUB_STEP_SUMMARY
          fi
