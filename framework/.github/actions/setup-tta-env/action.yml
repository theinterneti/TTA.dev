name: 'Setup TTA Development Environment'
description: 'Install uv and configure Python environment for TTA.dev'
author: 'TTA.dev Team'

inputs:
  python-version:
    description: 'Python version to use'
    required: false
    default: '3.12'

runs:
  using: 'composite'
  steps:
    - name: Cache uv binary
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/uv
        key: ${{ runner.os }}-uv-0.5.x

    - name: Install uv (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if ! command -v uv &> /dev/null; then
          echo "Installing uv..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
        else
          echo "uv already installed"
        fi

    - name: Install uv (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        if (!(Get-Command uv -ErrorAction SilentlyContinue)) {
          Write-Output "Installing uv..."
          irm https://astral.sh/uv/install.ps1 | iex
        } else {
          Write-Output "uv already installed"
        }

    - name: Add uv to PATH (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Add uv to PATH (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: echo "$env:USERPROFILE\.cargo\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Verify uv installation
      id: verify-uv
      shell: bash
      run: |
        # Retry mechanism for uv verification
        for i in {1..3}; do
          echo "Attempt $i: Verifying uv installation..."
          if uv --version; then
            echo "âœ… uv successfully installed and available"
            exit 0
          else
            echo "âš ï¸ uv verification failed, retrying..."
            sleep $((i * 2))
          fi
        done
        echo "âŒ uv verification failed after 3 attempts"
        exit 1

    - name: Validate MCP server connectivity (Optional)
      id: check-mcp-servers
      shell: bash
      continue-on-error: true
      run: |
        echo "ðŸ” Checking MCP server availability..."

        # Test GitHub MCP connection
        if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
          echo "Testing GitHub MCP server..."
          if curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/user > /dev/null 2>&1; then
            echo "âœ… GitHub MCP server reachable"
            echo "github-mcp=healthy" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ GitHub MCP server unreachable"
            echo "github-mcp=unhealthy" >> $GITHUB_OUTPUT
          fi
        else
          echo "â„¹ï¸ No GitHub token provided, skipping GitHub MCP check"
        fi

        # Check if Gemini API key is configured
        if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
          echo "âœ… Gemini API configured"
          echo "gemini-api=configured" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸ Gemini API not configured"
          echo "gemini-api=not-configured" >> $GITHUB_OUTPUT
        fi

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-python-${{ inputs.python-version }}-${{ hashFiles('uv.lock', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ inputs.python-version }}-
          ${{ runner.os }}-python-
          ${{ runner.os }}-
